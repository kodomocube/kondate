<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŒ®ç«‹ï¼†è²·ã„ç‰©ãƒªã‚¹ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <style>
        :root {
            --md-primary: #ff9ecd;
            --md-surface: #fff5f8;
            --md-secondary: #ffcc80;
            --md-salad: #c5e1a5;
            --md-soup: #ce93d8;
            --md-error: #ff5252;
        }
        body { font-family: 'Hiragino Sans', sans-serif; background: var(--md-surface); color: #5d4037; margin: 0; padding: 12px; padding-bottom: 60px; font-size: 14px; }
        .header-img-container { text-align: center; margin: 10px 0; }
        .header-img { width: 100%; max-width: 320px; border-radius: 25px; box-shadow: 0 8px 15px rgba(255, 158, 205, 0.3); }
        .card { background: #fff; padding: 16px; border-radius: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 16px; border: 2px solid #fff; }

        .details-content { padding-top: 15px; }

        button {
            position: relative; border: none; padding: 14px 20px; border-radius: 100px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 12px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); overflow: hidden; transition: transform 0.1s;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1), 0 8px 15px rgba(0,0,0,0.1), inset 0 -6px 8px rgba(0,0,0,0.2), inset 0 4px 8px rgba(255,255,255,0.4);
        }
        button::after { content: ""; position: absolute; top: 4px; left: 15%; width: 70%; height: 35%; background: linear-gradient(to bottom, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 100%); border-radius: 100px; pointer-events: none; }
        button:active { transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,0.1), inset 0 -3px 5px rgba(0,0,0,0.2), inset 0 4px 8px rgba(255,255,255,0.4); }

        .btn-main { background: linear-gradient(#ff9ecd, #ff69b4); }
        .btn-side { background: linear-gradient(#ffcc80, #ffa726); }
        .btn-salad { background: linear-gradient(#c5e1a5, #9ccc65); }
        .btn-soup { background: linear-gradient(#ce93d8, #ab47bc); }
        .btn-load { background: linear-gradient(#ce93d8, #ab47bc); }
        .btn-delete { background: linear-gradient(#ef9a9a, #e57373); }
        .btn-save { background: linear-gradient(#90caf9, #42a5f5); }
        .btn-csv { background: linear-gradient(#b0bec5, #78909c); }
        .btn-image { background: linear-gradient(#ff8aab, #f44336); }
        .btn-line { background: linear-gradient(#06C755, #05b34c); }
        .btn-furigana { background: linear-gradient(#4db6ac, #00897b); }

        .glossy-card { background: #ffffff !important; border: 3px solid #fff !important; box-shadow: 0 10px 25px rgba(255, 182, 193, 0.4) !important; position: relative; }

        h2 { font-size: 1.1rem; color: #ff69b4; text-shadow: 1px 1px 0 #fff; }
        input[type="text"], select { width: 100%; padding: 12px; margin-bottom: 8px; border: 2px solid #ffe0ea; border-radius: 20px; font-size: 16px; box-sizing: border-box; background: #fff; }

        .picker-trigger {
            width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #ffe0ea; border-radius: 20px; 
            background: #fff; text-align: left; color: #5d4037; font-size: 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .picker-trigger::after { content: "â–¼"; font-size: 10px; color: #ff9ecd; }
        .selected-tags { font-size: 0.75rem; color: #f06292; font-weight: bold; margin-top: 4px; display: block; }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; table-layout: fixed; }
        th.day-header { width: 35px; background: #ff9ecd; color: white; border-radius: 15px 0 0 15px; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
        td.menu-content { padding: 8px; background: white; border-radius: 0 15px 15px 0; border: 2px solid #fff; }
        
        .day-row-0 th.day-header { background-color: #fdd835 !important; }
        .day-row-1 th.day-header { background-color: #ef5350 !important; }
        .day-row-2 th.day-header { background-color: #4fc3f7 !important; }
        .day-row-3 th.day-header { background-color: #81c784 !important; }
        .day-row-4 th.day-header { background-color: #f06292 !important; }
        .day-row-5 th.day-header { background-color: #5c6bc0 !important; }
        .day-row-6 th.day-header { background-color: #d32f2f !important; }

        .dish-section { margin-bottom: 12px; padding: 8px; background: #fff9fb; border-radius: 15px; border: 1px solid #ffebee; }
        .dish-header-row { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 4px; }
        
        .dish-type-label { font-size: 0.6rem; font-weight: bold; padding: 2px 8px; border-radius: 20px; color: white; text-align: center; min-width: 40px; }
        .label-main { background-color: #f06292; }
        .label-side { background-color: #ffb74d; }
        .label-salad { background-color: #aed581; }
        .label-soup { background-color: #9575cd; }

        .fix-btn { font-size: 0.6rem; padding: 4px 10px; border-radius: 20px; border: 1px solid #ffc1e3; background: #fff; color: #f06292; font-weight: bold; min-width: 60px; text-align: center; cursor: pointer; }
        .fix-btn.fixed { background: #f06292; color: #fff; }
        
        .menu-select { width: 100% !important; flex: 0 0 100%; margin-top: 4px; padding: 8px; font-size: 0.9rem; border: 1px solid #ffd1dc; border-radius: 10px; color: #880e4f; background: #fff; box-sizing: border-box; }
        .search-link { text-decoration: none; font-size: 0.65rem; background: #fff; padding: 3px 8px; border-radius: 10px; color: #f06292; border: 1px solid #ffc1e3; font-weight: bold; white-space: nowrap; }

        #shoppingListBody { list-style: none; padding: 0; }
        #shoppingListBody li { background: #fff; margin-bottom: 8px; padding: 12px; border-radius: 20px; border: 2px solid #fff; box-shadow: 0 4px 8px rgba(255,182,193,0.3); display: flex; align-items: center; justify-content: space-between; color: #d81b60; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        #shoppingListBody li.checked { background: #eeeeee !important; color: #9e9e9e !important; text-decoration: line-through; box-shadow: none; border: 2px solid #ddd; }

        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .scroll-list { max-height: 200px; overflow-y: auto; border: 2px solid #ffe0ea; border-radius: 18px; padding: 8px; background: #fff; margin-bottom: 12px; }
        .list-item { background: #fffaf0; border: 1px solid #ffecb3; border-radius: 15px; padding: 8px; margin-bottom: 6px; display: flex; align-items: flex-start; gap: 8px; border-left: 6px solid #ffcc80; }

        .compact-mode#planCard .dish-section { display: none !important; }
        .compact-mode#planCard .drop-row { display: flex; margin-bottom: 4px; }
        .compact-mode#planCard .drop-row:last-child { margin-bottom: 0; }
        #planCard:not(.compact-mode) .drop-row { display: none !important; }

        .compact-mode#planCard table { border-spacing: 0; border: 1px solid #ffd1dc; border-radius: 15px; overflow: hidden; background: #fff; }
        .compact-mode#planCard th.day-header { width: 35px; font-size: 14px; border-radius: 0; border-right: 1px solid #ffd1dc; color: white !important; }
        .compact-mode#planCard td.menu-content { padding: 4px 8px; border-radius: 0; border-bottom: 2px solid #ffe0ea; display: flex; flex-direction: column; background: #fff !important; }
        
        .drop-row { gap: 4px; width: 100%; }
        .drop-badge { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4px 4px; border-radius: 12px; color: white !important; flex: 1; min-height: 40px; position: relative; text-align: center; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; }
        .drop-badge .dish-name { font-size: 11px; font-weight: bold; line-height: 1.1; margin-bottom: 2px; }
        
        .toggle-compact-btn { width: auto; padding: 6px 12px; font-size: 0.7rem; margin-bottom: 0; background: linear-gradient(#f06292, #e91e63); display: inline-block; vertical-align: middle; }
        .order-toggle-btn { width: auto; padding: 8px 16px; font-size: 0.9rem; margin-bottom: 0; display: inline-block; color: #fff !important; }
        .order-on { background: linear-gradient(#e65100, #bf360c); box-shadow: 0 4px 0 #870000; }
        .order-off { background: linear-gradient(#9e9e9e, #616161); box-shadow: 0 4px 0 #424242; }

        #dishPickerOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        #dishPickerContent { background: white; width: 100%; max-width: 500px; border-radius: 25px 25px 0 0; padding: 20px; box-sizing: border-box; max-height: 85%; overflow-y: auto; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .picker-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .picker-btn { background: #fff; border: 2px solid #ffe0ea; padding: 12px; border-radius: 15px; text-align: center; color: #5d4037; font-weight: bold; cursor: pointer; transition: background 0.2s; word-break: break-all; }
        .picker-btn.selected { background: #ff9ecd; color: white; border-color: #ff9ecd; }

        /* ãƒ«ãƒ“è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        ruby { font-size: 1.1em; line-height: 1.8; }
        rt { font-size: 0.55em; color: #f06292; letter-spacing: 0; }
    </style>
</head>
<body>

    <div class="header-img-container"><img src="cookingtitle.png" alt="Kodomo Cube" class="header-img"></div>
    <div style="text-align:center; padding: 0 16px;">
        <button class="btn-furigana" id="furiganaToggle" onclick="toggleFurigana()">ãµã‚ŠãŒãªãƒ¢ãƒ¼ãƒ‰: OFF</button>
    </div>
    <h1 style="text-align:center; color:#ff69b4; font-size:1.4rem; margin:10px 0; text-shadow: 2px 2px 0 #fff;" data-text="ğŸ€ çŒ®ç«‹ï¼†è²·ã„ç‰©ãƒªã‚¹ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼">ğŸ€ çŒ®ç«‹ï¼†è²·ã„ç‰©ãƒªã‚¹ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼</h1>

    <div class="card">
        <details><summary><h2 style="display:inline" data-text="ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†">ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†</h2></summary>
            <div class="details-content">
                <select id="profileSelect"></select>
                <div class="btn-row">
                    <button class="btn-load" onclick="loadProfile()" data-text="èª­ã¿è¾¼ã‚€">èª­ã¿è¾¼ã‚€</button>
                    <button class="btn-delete" onclick="deleteProfile()" data-text="å‰Šé™¤">å‰Šé™¤</button>
                </div>
                <hr style="border:0; border-top:2px dashed #ffe0ea; margin:12px 0;">
                <input type="text" id="profileName" placeholder="æ–°è¦ä¿å­˜å">
                <button class="btn-save" onclick="saveProfile()" data-text="ä¿å­˜">ä¿å­˜</button>
                <div class="btn-row">
                    <button class="btn-csv" onclick="exportCSV()" data-text="CSVå‡ºåŠ›">CSVå‡ºåŠ›</button>
                    <button class="btn-csv" onclick="document.getElementById('csvInput').click()" data-text="CSVå…¥åŠ›">CSVå…¥åŠ›</button>
                    <input type="file" id="csvInput" style="display:none" accept=".csv" onchange="importCSV(this)">
                </div>
            </div>
        </details>
    </div>

    <div class="card">
        <details><summary><h2 style="display:inline" data-text="æ–™ç†ã®ç™»éŒ²">æ–™ç†ã®ç™»éŒ²</h2></summary>
            <div class="details-content">
                <div class="btn-row"><input type="text" id="addName" placeholder="æ–™ç†å"><input type="text" id="addIng" placeholder="ææ–™"></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px;">
                    <button class="btn-main" onclick="addDish('main')" data-text="ä¸»èœè¿½åŠ ">ä¸»èœè¿½åŠ </button>
                    <button class="btn-side" onclick="addDish('side')" data-text="å‰¯èœè¿½åŠ ">å‰¯èœè¿½åŠ </button>
                    <button class="btn-salad" onclick="addDish('salad')" data-text="ã‚µãƒ©ãƒ€è¿½åŠ ">ã‚µãƒ©ãƒ€è¿½åŠ </button>
                    <button class="btn-soup" onclick="addDish('soup')" data-text="ã‚¹ãƒ¼ãƒ—è¿½åŠ ">ã‚¹ãƒ¼ãƒ—è¿½åŠ </button>
                </div>
            </div>
        </details>
    </div>

    <div class="card">
        <h2 data-text="ä½œæˆæ¡ä»¶">ä½œæˆæ¡ä»¶</h2>
        <label data-text="ğŸ  åœ¨åº«ãŒã‚ã‚‹é£Ÿæ">ğŸ  åœ¨åº«ãŒã‚ã‚‹é£Ÿæ</label>
        <div class="picker-trigger" onclick="openMultiPicker('inventory')">
            <div><span data-text="é¸æŠã™ã‚‹">é¸æŠã™ã‚‹</span><span id="inventoryLabel" class="selected-tags"></span></div>
        </div>

        <div style="background: #fff0f5; border: 2px solid #ffe0ea; border-radius: 20px; padding: 12px; margin: 10px 0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span data-text="åœ¨åº«é£Ÿæã‚’å„ªå…ˆæ´»ç”¨">åœ¨åº«é£Ÿæã‚’å„ªå…ˆæ´»ç”¨</span><input type="checkbox" id="priorityMode" checked>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span data-text="å‰¯èœ: ä½œã‚Šç½®ãæ—¥æ•°">å‰¯èœ: ä½œã‚Šç½®ãæ—¥æ•°</span>
                <select id="sideBatchDays" style="width: auto; margin-bottom: 0;">
                    <option value="1">1æ—¥</option>
                    <option value="3" selected>3æ—¥</option>
                    <option value="7">7æ—¥</option>
                </select>
            </div>
        </div>
        <label data-text="â­•ï¸ é£Ÿã¹ãŸã„æ–™ç†">â­•ï¸ é£Ÿã¹ãŸã„æ–™ç†</label>
        <div class="picker-trigger" onclick="openMultiPicker('want')">
            <div><span data-text="é¸æŠã™ã‚‹">é¸æŠã™ã‚‹</span><span id="wantLabel" class="selected-tags"></span></div>
        </div>
        <label data-text="âŒ é£Ÿã¹ãŸããªã„æ–™ç†">âŒ é£Ÿã¹ãŸããªã„æ–™ç†</label>
        <div class="picker-trigger" onclick="openMultiPicker('exclude')">
            <div><span data-text="é¸æŠã™ã‚‹">é¸æŠã™ã‚‹</span><span id="excludeLabel" class="selected-tags"></span></div>
        </div>
        <button class="btn-main" style="height:70px; font-size:1.1rem;" onclick="generatePlan()" data-text="å›ºå®šã—ã¦ã„ãªã„çŒ®ç«‹ã‚’è‡ªå‹•ä½œæˆ">å›ºå®šã—ã¦ã„ãªã„çŒ®ç«‹ã‚’è‡ªå‹•ä½œæˆ</button>
    </div>

    <div class="card glossy-card compact-mode" id="planCard">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0;" data-text="ğŸ“… ä»Šé€±ã®çŒ®ç«‹">ğŸ“… ä»Šé€±ã®çŒ®ç«‹</h2>
            <button class="toggle-compact-btn" onclick="toggleCompact()" data-text="è©³ç´°è¡¨ç¤ºã«ã™ã‚‹">è©³ç´°è¡¨ç¤ºã«ã™ã‚‹</button>
        </div>
        <table><tbody id="planBody"></tbody></table>
        <div class="btn-row">
            <button class="btn-load" onclick="clearUnfixed()" data-text="å›ºå®šä»¥å¤–ã‚¯ãƒªã‚¢">å›ºå®šä»¥å¤–ã‚¯ãƒªã‚¢</button>
            <button class="btn-save" onclick="copyText('planBody')" data-text="ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼">ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼</button>
        </div>
        <div class="btn-row">
            <button class="btn-image" onclick="saveAsImage('planCard', 'ä»Šé€±ã®çŒ®ç«‹')" data-text="ç”»åƒä¿å­˜">ç”»åƒä¿å­˜</button>
            <button class="btn-line" onclick="shareAsImage('planCard', 'ä»Šé€±ã®çŒ®ç«‹')" data-text="ç”»åƒã‚’LINEç­‰ã§é€ã‚‹">ç”»åƒã‚’LINEç­‰ã§é€ã‚‹</button>
        </div>
    </div>

    <div class="card glossy-card" id="shoppingListCard">
        <h2 data-text="ğŸ›’ è²·ã„ç‰©ãƒªã‚¹ãƒˆ">ğŸ›’ è²·ã„ç‰©ãƒªã‚¹ãƒˆ</h2>
        <ul id="shoppingListBody"></ul>
        <div class="btn-row">
            <button class="btn-save" onclick="copyText('shoppingListBody')" data-text="ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼">ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼</button>
            <button class="btn-line" onclick="sendToLine()" data-text="LINEã§é€ã‚‹">LINEã§é€ã‚‹</button>
        </div>
    </div>

    <div id="dishPickerOverlay" onclick="closeDishPicker()">
        <div id="dishPickerContent" onclick="event.stopPropagation()">
            <div class="picker-title" id="pickerTitle"></div>
            <div id="pickerFixArea"></div>
            <div class="picker-grid" id="pickerGrid"></div>
            <button class="btn-delete" style="margin-top:20px;" onclick="closeDishPicker()" data-text="é–‰ã˜ã‚‹">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        const STORAGE_KEY_DATA = 'Kondate_V50_Data';
        const STORAGE_KEY_PROFILES = 'Kondate_V50_Profiles';
        const DAYS = ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"];
        
        let isFuriganaMode = false;
        let selectedInv = new Set();
        let selectedWant = new Set();
        let selectedExclude = new Set();
        let data = JSON.parse(localStorage.getItem(STORAGE_KEY_DATA)) || { mains:[], sides:[], salads:[], soups:[], currentPlan: Array.from({length: 7}, () => ({ main: "", side: "", salad: "", soup: "", mainFixed: false, sideFixed: false, saladFixed: false, soupFixed: false })) };
        let profiles = JSON.parse(localStorage.getItem(STORAGE_KEY_PROFILES)) || {};

        const FURIGANA_MAP = {
            "çŒ®ç«‹": "ã“ã‚“ã ã¦", "è²·": "ã‹", "ç‰©": "ã‚‚ã®", "ä½œ": "ã¤ã", "æˆ": "ã›ã„", "æ¡": "ã˜ã‚‡ã†", "ä»¶": "ã‘ã‚“", "åœ¨": "ã–ã„", "åº«": "ã“", "é£Ÿ": "ã—ã‚‡ã", "æ": "ã–ã„", "é¸": "ã›ã‚“", "æŠ": "ãŸã", "ç†": "ã‚Š", "ç®¡": "ã‹ã‚“", "ç™»": "ã¨ã†", "éŒ²": "ã‚ã", "é€±": "ã—ã‚…ã†", "ä¸»": "ã—ã‚…", "èœ": "ã•ã„", "å‰¯": "ãµã", "æ±": "ã—ã‚‹", "å›ºå®š": "ã“ã¦ã„", "ä»¥å¤–": "ã„ãŒã„", "ç”»åƒ": "ãŒãã†", "ä¿å­˜": "ã»ãã‚“", "è©³": "ã—ã‚‡ã†", "ç´°": "ã•ã„", "è¡¨": "ã²ã‚‡ã†", "ç¤º": "ã˜", "å„ªå…ˆ": "ã‚†ã†ã›ã‚“", "æ´»ç”¨": "ã‹ã¤ã‚ˆã†", "æ—¥": "ã«ã¡", "æ•°": "ã™ã†"
        };

        function toggleFurigana() {
            isFuriganaMode = !isFuriganaMode;
            document.getElementById('furiganaToggle').innerText = `ãµã‚ŠãŒãªãƒ¢ãƒ¼ãƒ‰: ${isFuriganaMode ? 'ON' : 'OFF'}`;
            applyFuriganaAll();
            renderTable(); // å‹•çš„è¦ç´ ã®å†æç”»
        }

        function applyFuriganaAll() {
            const elements = document.querySelectorAll('[data-text]');
            elements.forEach(el => {
                const originalText = el.getAttribute('data-text');
                el.innerHTML = isFuriganaMode ? convertToRuby(originalText) : originalText;
            });
        }

        function convertToRuby(text) {
            let result = text;
            Object.keys(FURIGANA_MAP).forEach(kanji => {
                const regex = new RegExp(kanji, 'g');
                result = result.replace(regex, `<ruby>${kanji}<rt>${FURIGANA_MAP[kanji]}</rt></ruby>`);
            });
            return result;
        }

        async function init() { updateProfileSelect(); renderTable(); updateLabels(); }

        function renderTable() {
            let html = "";
            DAYS.forEach((day, i) => {
                const p = data.currentPlan[i];
                html += `<tr class="day-row day-row-${i}">
                    <th class="day-header">${day}</th>
                    <td class="menu-content">
                        <div class="drop-row">${renderBadge(i, 'main', '#f06292', 'ä¸»èœ')}${renderBadge(i, 'side', '#ffb74d', 'å‰¯èœ')}</div>
                        <div class="drop-row">${renderBadge(i, 'salad', '#aed581', 'ã‚µãƒ©ãƒ€')}${renderBadge(i, 'soup', '#9575cd', 'ã‚¹ãƒ¼ãƒ—')}</div>
                    </td>
                </tr>`;
            });
            document.getElementById('planBody').innerHTML = html;
            updateShoppingList();
        }

        function renderBadge(dayIdx, type, color, label) {
            const name = data.currentPlan[dayIdx][type];
            const isFixed = data.currentPlan[dayIdx][type + 'Fixed'];
            const displayText = name ? (isFuriganaMode ? convertToRuby(name) : name) : (isFuriganaMode ? convertToRuby(label + "ãªã—") : label + "ãªã—");
            return `<span class="drop-badge" style="background-color:${name ? color : '#eee'}; color:${name ? 'white' : '#999'};" onclick="openDishPicker(${dayIdx},'${type}')">
                <div class="dish-name">${isFixed ? 'ğŸ”’' : ''}${displayText}</div>
            </span>`;
        }

        function openMultiPicker(mode) {
            const overlay = document.getElementById('dishPickerOverlay');
            const grid = document.getElementById('pickerGrid');
            let items = [], selectedSet, title;
            if (mode === 'inventory') { items = [...new Set(['mains', 'sides', 'salads', 'soups'].flatMap(k => data[k].flatMap(d => d.ing)))].sort(); selectedSet = selectedInv; title = "åœ¨åº«ãŒã‚ã‚‹é£Ÿæ"; }
            else { items = ['mains', 'sides', 'salads', 'soups'].flatMap(k => data[k].map(d => d.name)).sort(); selectedSet = (mode === 'want') ? selectedWant : selectedExclude; title = (mode === 'want') ? "â­•ï¸ é£Ÿã¹ãŸã„æ–™ç†" : "âŒ é£Ÿã¹ãŸããªã„æ–™ç†"; }
            
            document.getElementById('pickerTitle').innerText = title;
            grid.innerHTML = "";
            items.forEach(item => {
                const btn = document.createElement('div');
                btn.className = `picker-btn ${selectedSet.has(item) ? 'selected' : ''}`;
                btn.innerHTML = isFuriganaMode ? convertToRuby(item) : item;
                btn.onclick = () => { if (selectedSet.has(item)) selectedSet.delete(item); else selectedSet.add(item); btn.classList.toggle('selected'); updateLabels(); };
                grid.appendChild(btn);
            });
            overlay.style.display = 'flex';
        }

        function updateLabels() {
            document.getElementById('inventoryLabel').innerText = Array.from(selectedInv).join('ã€') || "ãªã—";
            document.getElementById('wantLabel').innerText = Array.from(selectedWant).join('ã€') || "ãªã—";
            document.getElementById('excludeLabel').innerText = Array.from(selectedExclude).join('ã€') || "ãªã—";
        }

        function openDishPicker(dayIdx, type) {
            const overlay = document.getElementById('dishPickerOverlay');
            const grid = document.getElementById('pickerGrid');
            const isFixed = data.currentPlan[dayIdx][type + 'Fixed'];
            document.getElementById('pickerTitle').innerText = DAYS[dayIdx] + "æ›œæ—¥ã®æ–™ç†";
            document.getElementById('pickerFixArea').innerHTML = `<div class="fix-toggle-panel" style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; background:#fff0f5; padding:10px; border-radius:15px; border:2px solid #ffc1e3;" onclick="toggleFix(${dayIdx},'${type}'); openDishPicker(${dayIdx},'${type}')"><span>${isFixed ? 'ğŸ”’ å›ºå®šä¸­' : 'ğŸ”“ æœªå›ºå®š'}</span><button class="fix-btn ${isFixed?'fixed':''}" style="margin:0">${isFixed?'è§£é™¤':'å›ºå®š'}</button></div>`;
            grid.innerHTML = `<div class="picker-btn" style="grid-column:span 2; background:#f5f5f5;" onclick="updateChoice(${dayIdx},'${type}',''); closeDishPicker();">ãªã—</div>`;
            data[type + 's'].forEach(dish => {
                const btn = document.createElement('div');
                btn.className = "picker-btn";
                btn.innerHTML = isFuriganaMode ? convertToRuby(dish.name) : dish.name;
                btn.onclick = () => { updateChoice(dayIdx, type, dish.name); closeDishPicker(); };
                grid.appendChild(btn);
            });
            overlay.style.display = 'flex';
        }

        function updateChoice(i, type, val) { data.currentPlan[i][type] = val; renderTable(); saveToLocal(); }
        function toggleFix(i, type) { data.currentPlan[i][type + 'Fixed'] = !data.currentPlan[i][type + 'Fixed']; renderTable(); saveToLocal(); }
        function closeDishPicker() { document.getElementById('dishPickerOverlay').style.display = 'none'; }
        function toggleCompact() { document.getElementById('planCard').classList.toggle('compact-mode'); renderTable(); }
        function saveToLocal() { localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(data)); }
        function updateProfileSelect() { /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ›´æ–°å‡¦ç† */ }

        init();
    </script>
</body>
</html>
