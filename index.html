<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŒ®ç«‹ï¼†è²·ã„ç‰©ãƒªã‚¹ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <style>
        :root {
            /* ãƒœãƒ³ãƒœãƒ³ãƒ‰ãƒ­ãƒƒãƒ—é¢¨ãƒ‘ãƒ¬ãƒƒãƒˆ */
            --md-primary: #ff9ecd; /* ãƒ”ãƒ¼ãƒãƒ”ãƒ³ã‚¯ */
            --md-surface: #fff5f8;
            --md-secondary: #ffcc80; /* ã‚ªãƒ¬ãƒ³ã‚¸ã‚°ãƒŸ */
            --md-salad: #c5e1a5; /* ãƒã‚¹ã‚«ãƒƒãƒˆ */
            --md-soup: #ce93d8; /* ã‚°ãƒ¬ãƒ¼ãƒ— */
            --md-error: #ff5252;
            --shadow-drop: 0 8px 15px rgba(255, 158, 205, 0.2);
            --glossy: linear-gradient(135deg, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 50%);
        }
        body { font-family: 'Hiragino Sans', sans-serif; background: var(--md-surface); color: #5d4037; margin: 0; padding: 12px; padding-bottom: 60px; font-size: 14px; }
        .header-img-container { text-align: center; margin: 10px 0; }
        .header-img { width: 100%; max-width: 320px; border-radius: 25px; box-shadow: var(--shadow-drop); }
        .card { background: #fff; padding: 16px; border-radius: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 16px; border: 2px solid #fff; }

        /* ãƒ‰ãƒ­ãƒƒãƒ—ã‚·ãƒ¼ãƒ«é¢¨ãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆçŒ®ç«‹ã¨ãƒªã‚¹ãƒˆã«é©ç”¨ï¼‰ */
        .glossy-card {
            background: linear-gradient(180deg, #ffffff 0%, #fff0f5 100%) !important;
            border: 3px solid #fff !important;
            box-shadow: 0 10px 20px rgba(255, 182, 193, 0.4), inset 0 -5px 10px rgba(255, 255, 255, 0.8) !important;
            position: relative;
            overflow: hidden;
        }
        /* ã‚·ãƒ¼ãƒ«ã®ãƒ„ãƒ¤å‡ºã— */
        .glossy-card::before {
            content: ""; position: absolute; top: 5px; left: 10%; width: 80%; height: 15px;
            background: rgba(255,255,255,0.6); border-radius: 50%; filter: blur(2px); pointer-events: none;
        }

        h2 { font-size: 1.1rem; color: #ff69b4; margin: 0; display: inline; text-shadow: 1px 1px 0 #fff; }
        summary { cursor: pointer; outline: none; display: flex; align-items: center; border-left: 8px solid var(--md-primary); padding-left: 12px; border-radius: 4px; }
        summary::-webkit-details-marker { display: none; }
        summary::after { content: ' ğŸ­'; font-size: 0.8rem; margin-left: auto; }
        
        input[type="text"], select { width: 100%; padding: 12px; margin-bottom: 8px; border: 2px solid #ffe0ea; border-radius: 18px; font-size: 16px; box-sizing: border-box; background: #fff; }
        button { background: linear-gradient(to bottom, #ff9ecd, #ff69b4); color: white; border: none; padding: 14px; border-radius: 100px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 8px; box-shadow: 0 4px 0 #db4d8d; }
        button:active { transform: translateY(2px); box-shadow: 0 2px 0 #db4d8d; }
        
        .scroll-list { max-height: 200px; overflow-y: auto; border: 2px solid #ffe0ea; border-radius: 18px; padding: 8px; background: #fff; margin-bottom: 12px; }
        .list-item { background: #fffaf0; border: 1px solid #ffecb3; border-radius: 15px; padding: 8px; margin-bottom: 6px; display: flex; align-items: flex-start; gap: 8px; border-left: 6px solid #ffcc80; }

        /* çŒ®ç«‹ãƒ†ãƒ¼ãƒ–ãƒ« */
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; table-layout: fixed; }
        tr.day-row { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.05)); }
        th.day-header { width: 32px; background: #ff9ecd; color: white; padding: 12px 2px; text-align: center; border-radius: 15px 0 0 15px; font-size: 0.9rem; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
        td.menu-content { padding: 8px; background: white; border-radius: 0 15px 15px 0; border: 2px solid #fff; }
        
        .dish-section { margin-bottom: 8px; padding: 6px; background: #fff9fb; border-radius: 12px; border: 1px solid #ffebee; }
        .dish-type-label { font-size: 0.55rem; font-weight: bold; padding: 2px 6px; border-radius: 10px; color: white; min-width: 35px; text-align: center; box-shadow: inset 0 2px 4px rgba(255,255,255,0.3); }
        .label-main { background: #f06292; }
        .label-side { background: #ffb74d; }
        .label-salad { background: #aed581; }
        .label-soup { background: #9575cd; }

        .fix-btn { font-size: 0.55rem; padding: 2px 6px; border-radius: 10px; border: 1px solid #ffc1e3; background: #fff; cursor: pointer; color: #f06292; font-weight: bold; min-width: 48px; }
        .fix-btn.fixed { background: #f06292; color: #fff; border-color: #f06292; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .menu-select { flex-grow: 1; padding: 4px; font-size: 0.85rem; font-weight: bold; border: 1px solid #ffd1dc; background: #fff; border-radius: 8px; color: #880e4f; }
        
        .search-link { text-decoration: none; font-size: 0.6rem; background: #fff; padding: 2px 6px; border-radius: 8px; color: #f06292; border: 1px solid #ffc1e3; margin-right: 4px; font-weight: bold; }
        .ing-text { font-size: 0.65rem; color: #9e9e9e; margin-top: 4px; display: block; }

        /* è²·ã„ç‰©ãƒªã‚¹ãƒˆ */
        #shoppingListBody { list-style: none; padding: 0; }
        #shoppingListBody li { background: #fff; margin-bottom: 6px; padding: 10px; border-radius: 15px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(255,182,193,0.2); display: flex; align-items: center; justify-content: space-between; font-weight: bold; color: #d81b60; }
        .batch-tag { font-size: 9px; background: #e1f5fe; color: #0288d1; padding: 2px 6px; border-radius: 10px; margin-left: 6px; }

        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    </style>
</head>
<body>

    <div class="header-img-container"><img src="title.jpg" alt="Kodomo Cube" class="header-img"></div>
    <h1 style="text-align:center; color:#ff69b4; font-size:1.4rem; margin:10px 0; text-shadow: 2px 2px 0 #fff;">ğŸ€ çŒ®ç«‹ï¼†è²·ã„ç‰©ãƒªã‚¹ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼</h1>

    <div class="card">
        <details><summary><h2>ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†</h2></summary>
            <div class="details-content">
                <select id="profileSelect"></select>
                <div class="btn-row">
                    <button onclick="loadProfile()" style="background:#ce93d8; box-shadow: 0 4px 0 #ab47bc;">èª­ã¿è¾¼ã‚€</button>
                    <button onclick="deleteProfile()" style="background:#ef9a9a; box-shadow: 0 4px 0 #e57373;">å‰Šé™¤</button>
                </div>
                <hr style="border:0; border-top:2px dashed #ffe0ea; margin:12px 0;">
                <input type="text" id="profileName" placeholder="æ–°è¦ä¿å­˜å">
                <button onclick="saveProfile()" style="background:#90caf9; box-shadow: 0 4px 0 #42a5f5;">ä¿å­˜</button>
                <div class="btn-row">
                    <button onclick="exportCSV()" style="background:#b0bec5; font-size:0.8rem; box-shadow: 0 4px 0 #78909c;">CSVå‡ºåŠ›</button>
                    <button onclick="document.getElementById('csvInput').click()" style="background:#b0bec5; font-size:0.8rem; box-shadow: 0 4px 0 #78909c;">CSVå…¥åŠ›</button>
                    <input type="file" id="csvInput" style="display:none" accept=".csv" onchange="importCSV(this)">
                </div>
            </div>
        </details>
    </div>

    <div class="card">
        <details><summary><h2>æ–™ç†ã®ç™»éŒ²</h2></summary>
            <div class="details-content">
                <div class="btn-row"><input type="text" id="addName" placeholder="æ–™ç†å"><input type="text" id="addIng" placeholder="ææ–™"></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:8px;">
                    <button onclick="addDish('main')">ä¸»èœè¿½åŠ </button>
                    <button onclick="addDish('side')" style="background:#ffcc80; box-shadow: 0 4px 0 #ffa726;">å‰¯èœè¿½åŠ </button>
                    <button onclick="addDish('salad')" style="background:#c5e1a5; box-shadow: 0 4px 0 #9ccc65;">ã‚µãƒ©ãƒ€è¿½åŠ </button>
                    <button onclick="addDish('soup')" style="background:#ce93d8; box-shadow: 0 4px 0 #ab47bc;">ã‚¹ãƒ¼ãƒ—è¿½åŠ </button>
                </div>
                <label>ä¸»èœ</label><div id="mainListDisplay" class="scroll-list"></div>
                <label>å‰¯èœ</label><div id="sideListDisplay" class="scroll-list"></div>
                <label>ã‚µãƒ©ãƒ€</label><div id="saladListDisplay" class="scroll-list"></div>
                <label>ã‚¹ãƒ¼ãƒ—</label><div id="soupListDisplay" class="scroll-list"></div>
            </div>
        </details>
    </div>

    <div class="card">
        <h2>ä½œæˆæ¡ä»¶</h2>
        <label>ğŸ  åœ¨åº«ã«ã‚ã‚‹é£Ÿæ</label><select id="inventorySelect" multiple></select>
        <div class="switch-group" style="background: #fff0f5; border: 2px solid #ffe0ea; border-radius: 20px; padding: 12px; margin: 10px 0;">
            <div class="switch-container"><span>åœ¨åº«é£Ÿæã‚’å„ªå…ˆæ´»ç”¨</span><label class="switch"><input type="checkbox" id="priorityMode" checked><span class="slider"></span></label></div>
            <div class="switch-container"><span>å‰¯èœ: <span class="mode-label" id="sideBatchModeLabel">3æ—¥åˆ†ä½œã‚Šç½®ãON</span></span><label class="switch"><input type="checkbox" id="sideBatchMode" checked onchange="updateModeLabel('side')"><span class="slider"></span></label></div>
        </div>
        <label>âŒ é£Ÿã¹ãŸããªã„æ–™ç†</label><select id="excludeSelect" multiple></select>
        <label>â­ é£Ÿã¹ãŸã„æ–™ç†</label><select id="wantToEatSelect" multiple></select>
        <button onclick="generatePlan()" style="height:60px; font-size:1.1rem; margin-top:10px;">å›ºå®šã—ã¦ã„ãªã„çŒ®ç«‹ã‚’è‡ªå‹•ä½œæˆ</button>
    </div>

    <div class="card glossy-card" id="planCard">
        <h2>ğŸ“… ä»Šé€±ã®çŒ®ç«‹</h2>
        <table><tbody id="planBody"></tbody></table>
        <div class="btn-row">
            <button onclick="clearUnfixed()" style="background:#ce93d8; box-shadow: 0 4px 0 #ab47bc;">å›ºå®šä»¥å¤–ã‚¯ãƒªã‚¢</button>
            <button onclick="copyText('planBody')" style="background:#90caf9; box-shadow: 0 4px 0 #42a5f5;">ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼</button>
        </div>
        <button onclick="saveAsImage('planCard', 'ä»Šé€±ã®çŒ®ç«‹')" style="background:#ff8aab; box-shadow: 0 4px 0 #f44336; margin-top:8px;">ç”»åƒä¿å­˜</button>
    </div>

    <div class="card glossy-card" id="shoppingListCard">
        <h2>ğŸ›’ è²·ã„ç‰©ãƒªã‚¹ãƒˆ</h2>
        <ul id="shoppingListBody"></ul>
        <div class="btn-row">
            <button onclick="copyText('shoppingListBody')" style="background:#90caf9; box-shadow: 0 4px 0 #42a5f5;">ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼</button>
            <button onclick="saveAsImage('shoppingListCard', 'è²·ã„ç‰©ãƒªã‚¹ãƒˆ')" style="background:#ff8aab; box-shadow: 0 4px 0 #f44336;">ç”»åƒä¿å­˜</button>
        </div>
    </div>

    <script>
        /* ã‚¹ã‚¯ãƒªãƒ—ãƒˆéƒ¨åˆ†ã¯å‰å›ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨å…¨ãåŒã˜ï¼ˆè¡¨ç¤ºæ–‡å­—åˆ—ã®ã¿å¤‰æ›´ã‚’åæ˜ ï¼‰ */
        const STORAGE_KEY_DATA = 'Kondate_V50_Data';
        const STORAGE_KEY_PROFILES = 'Kondate_V50_Profiles';
        const SAMPLE_KEY = "ã‚µãƒ³ãƒ—ãƒ«(å®šç•ª)";
        const GITHUB_CSV_URL = "https://raw.githubusercontent.com/kodomocube/kondate/main/sample.csv";
        const DAYS = ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"];

        let profiles = JSON.parse(localStorage.getItem(STORAGE_KEY_PROFILES)) || {};
        let data = JSON.parse(localStorage.getItem(STORAGE_KEY_DATA)) || { mains:[], sides:[], salads:[], soups:[], currentPlan: Array.from({length: 7}, () => ({ main: "", side: "", salad: "", soup: "", mainFixed: false, sideFixed: false, saladFixed: false, soupFixed: false })) };

        async function init() {
            await syncSampleFromGitHubCSV();
            updateProfileSelect();
            renderAll();
            renderTable();
            updateModeLabel('side');
        }

        async function syncSampleFromGitHubCSV() {
            try {
                const response = await fetch(GITHUB_CSV_URL);
                if (!response.ok) throw new Error("GitHub fetch failed");
                const csvText = await response.text();
                const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== "");
                const mains = [], sides = [], salads = [], soups = [];
                for (let i = 1; i < lines.length; i++) {
                    const [type, name, ingString] = lines[i].split(',');
                    if (!type || !name) continue;
                    const dish = { name: name.trim(), ing: ingString ? ingString.split('/').map(s => s.trim()) : [] };
                    const t = type.trim().toLowerCase();
                    if (t === 'main') mains.push(dish);
                    else if (t === 'side') sides.push(dish);
                    else if (t === 'salad') salads.push(dish);
                    else if (t === 'soup') soups.push(dish);
                }
                const githubProfile = { mains, sides, salads, soups, currentPlan: Array.from({length: 7}, () => ({ main: "", side: "", salad: "", soup: "", mainFixed: false, sideFixed: false, saladFixed: false, soupFixed: false })) };
                profiles[SAMPLE_KEY] = githubProfile;
                localStorage.setItem(STORAGE_KEY_PROFILES, JSON.stringify(profiles));
                if (data.mains.length === 0) {
                    data = JSON.parse(JSON.stringify(githubProfile));
                    saveToLocal();
                }
            } catch (e) { console.warn("GitHub CSV sync failed.", e); }
        }

        function updateModeLabel(key) {
            const isBatch = document.getElementById(key + 'BatchMode').checked;
            document.getElementById(key + 'ModeLabel').innerText = isBatch ? "3æ—¥åˆ†ä½œã‚Šç½®ãON" : "3æ—¥åˆ†ä½œã‚Šç½®ãOFF";
            document.getElementById(key + 'ModeLabel').style.color = isBatch ? "#f06292" : "#999";
        }

        function renderAll() {
            ['main', 'side', 'salad', 'soup'].forEach(t => renderFullList(t));
            updateSelectors();
            saveToLocal();
        }

        function renderFullList(type) {
            const list = data[type + 's'];
            const container = document.getElementById(type + 'ListDisplay');
            container.innerHTML = list.map((d, i) => `
                <div class="list-item">
                    <div class="edit-area">
                        <span class="dish-name-edit" contenteditable="true" onblur="updateDishData('${type}',${i},'name',this)">${d.name}</span>
                        <span class="dish-ing-edit" contenteditable="true" onblur="updateDishData('${type}',${i},'ing',this)">${d.ing.join('ã€')}</span>
                    </div>
                    <span style="color:red; cursor:pointer;" onclick="deleteDish('${type}',${i})">âœ•</span>
                </div>`).join('');
        }

        function updateDishData(t, i, f, el) {
            const val = el.innerText.trim();
            if (f === 'name') data[t + 's'][i].name = val;
            else data[t + 's'][i].ing = val.split(/[ã€,]+/).map(s => s.trim());
            renderAll(); renderTable();
        }

        function addDish(t) {
            const n = document.getElementById('addName').value.trim();
            const g = document.getElementById('addIng').value.split(/[ã€,]+/).map(s => s.trim()).filter(s => s);
            if (n) { data[t + 's'].push({ name: n, ing: g }); renderAll(); renderTable(); }
            document.getElementById('addName').value = ''; document.getElementById('addIng').value = '';
        }

        function deleteDish(t, i) { data[t + 's'].splice(i, 1); renderAll(); renderTable(); }

        function updateSelectors() {
            const allIng = [...new Set(['mains', 'sides', 'salads', 'soups'].flatMap(k => data[k].flatMap(d => d.ing)))].sort();
            const allNames = ['mains', 'sides', 'salads', 'soups'].flatMap(k => data[k].map(d => d.name)).sort();
            document.getElementById('inventorySelect').innerHTML = allIng.map(i => `<option value="${i}">${i}</option>`).join('');
            document.getElementById('excludeSelect').innerHTML = allNames.map(n => `<option value="${n}">${n}</option>`).join('');
            document.getElementById('wantToEatSelect').innerHTML = allNames.map(n => `<option value="${n}">${n}</option>`).join('');
        }

        function renderTable() {
            let html = "";
            DAYS.forEach((day, i) => {
                const p = data.currentPlan[i];
                html += `<tr class="day-row">
                    <th class="day-header">${day}</th>
                    <td class="menu-content">
                        ${renderRow(i, 'main', 'ä¸»èœ', 'label-main')}
                        ${renderRow(i, 'side', 'å‰¯èœ', 'label-side')}
                        ${renderRow(i, 'salad', 'ã‚µãƒ©ãƒ€', 'label-salad')}
                        ${renderRow(i, 'soup', 'ã‚¹ãƒ¼ãƒ—', 'label-soup')}
                    </td>
                </tr>`;
            });
            document.getElementById('planBody').innerHTML = html;
            updateShoppingList();
        }

        function renderRow(dayIdx, type, label, labelClass) {
            const p = data.currentPlan[dayIdx];
            const currentName = p[type];
            const isFixed = p[type + 'Fixed'];
            const dish = data[type + 's'].find(d => d.name === currentName) || {name:"", ing:[]};
            const encodedName = encodeURIComponent(currentName);
            const rakutenUrl = currentName ? `https://recipe.rakuten.co.jp/search/${encodedName}/` : null;
            const cookpadUrl = currentName ? `https://cookpad.com/search/${encodedName}` : null;

            return `
            <div class="dish-section">
                <div class="dish-header-row" style="display:flex; align-items:center; gap:4px; margin-bottom:4px; flex-wrap:wrap;">
                    <span class="dish-type-label ${labelClass}">${label}</span>
                    <span class="fix-btn ${isFixed?'fixed':''}" onclick="toggleFix(${dayIdx},'${type}')">${isFixed?'å›ºå®šON':'å›ºå®šOFF'}</span>
                    <select class="menu-select" onchange="updateChoice(${dayIdx},'${type}',this.value)">
                        <option value="">ãªã—</option>
                        ${data[type + 's'].map(d => `<option value="${d.name}" ${d.name===currentName?'selected':''}>${d.name}</option>`).join('')}
                    </select>
                </div>
                ${currentName ? `
                <div class="recipe-links-row" style="display:flex; gap:4px; margin-top:2px;">
                    <a href="${rakutenUrl}" target="_blank" class="search-link">æ¥½å¤©ãƒ¬ã‚·ãƒ”</a>
                    <a href="${cookpadUrl}" target="_blank" class="search-link">ã‚¯ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰</a>
                </div>` : ''}
                <small class="ing-text">${dish.ing.join('ã€')}</small>
            </div>`;
        }

        function toggleFix(i, type) { data.currentPlan[i][type + 'Fixed'] = !data.currentPlan[i][type + 'Fixed']; renderTable(); saveToLocal(); }
        function updateChoice(i, type, val) { data.currentPlan[i][type] = val; renderTable(); saveToLocal(); }

        function generatePlan() {
            const inv = Array.from(document.getElementById('inventorySelect').selectedOptions).map(o => o.value);
            const exc = Array.from(document.getElementById('excludeSelect').selectedOptions).map(o => o.value);
            const want = Array.from(document.getElementById('wantToEatSelect').selectedOptions).map(o => o.value);
            const prio = document.getElementById('priorityMode').checked;
            const sideBatch = document.getElementById('sideBatchMode').checked;

            let usedM = data.currentPlan.filter(p => p.mainFixed).map(p => p.main);
            DAYS.forEach((_, i) => {
                if(!data.currentPlan[i].mainFixed) {
                    const d = pickDish(data.mains.filter(d => !exc.includes(d.name) && !usedM.includes(d.name)), want, inv, prio);
                    data.currentPlan[i].main = d.name; if(d.name) usedM.push(d.name);
                }
            });
            let currentSide = "";
            let usedS = data.currentPlan.filter(p => p.sideFixed).map(p => p.side);
            DAYS.forEach((_, i) => {
                if(!data.currentPlan[i].sideFixed) {
                    if(sideBatch) {
                        if(i%3===0) {
                            const d = pickDish(data.sides.filter(d => !exc.includes(d.name) && !usedS.includes(d.name)), want, inv, prio);
                            currentSide = d.name; if(d.name) usedS.push(d.name);
                        }
                        data.currentPlan[i].side = currentSide;
                    } else {
                        const d = pickDish(data.sides.filter(d => !exc.includes(d.name) && !usedS.includes(d.name)), want, inv, prio);
                        data.currentPlan[i].side = d.name; if(d.name) usedS.push(d.name);
                    }
                }
            });
            ['salad', 'soup'].forEach(type => {
                let used = data.currentPlan.filter(p => p[type+'Fixed']).map(p => p[type]);
                DAYS.forEach((_, i) => {
                    if(!data.currentPlan[i][type+'Fixed']) {
                        const d = pickDish(data[type+'s'].filter(d => !exc.includes(d.name) && !used.includes(d.name)), want, inv, prio);
                        data.currentPlan[i][type] = d.name; if(d.name) used.push(d.name);
                    }
                });
            });
            renderTable(); saveToLocal();
        }

        function pickDish(pool, want, inv, prio) {
            if (!pool.length) return {name:"", ing:[]};
            let shuffled = shuffle([...pool]);
            let f = shuffled.filter(d => want.includes(d.name));
            if (!f.length && prio) f = shuffled.filter(d => d.ing.some(i => inv.includes(i)));
            return (f.length ? f : shuffled)[0];
        }

        function shuffle(a) { for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} return a; }

        function updateShoppingList() {
            const inv = Array.from(document.getElementById('inventorySelect').selectedOptions).map(o => o.value);
            let ings = new Set();
            data.currentPlan.forEach(p => {
                ['main', 'side', 'salad', 'soup'].forEach(t => {
                    const d = data[t+'s'].find(x => x.name === p[t]);
                    if(d) d.ing.forEach(ing => ings.add(ing));
                });
            });
            document.getElementById('shoppingListBody').innerHTML = Array.from(ings).sort().map(ing => `
                <li><span>${ing}</span><div>${inv.includes(ing)?'<span class="batch-tag">åœ¨åº«ã‚ã‚Š</span>':''}
                <a href="https://sm.rakuten.co.jp/search?keyword=${encodeURIComponent(ing)}" target="_blank" class="search-link" style="margin-left:8px">ğŸ›’</a></div></li>`).join('');
        }

        function updateProfileSelect() {
            const select = document.getElementById('profileSelect');
            let options = `<option value="${SAMPLE_KEY}">${SAMPLE_KEY}</option>`;
            Object.keys(profiles).forEach(name => { if (name !== SAMPLE_KEY) options += `<option value="${name}">${name}</option>`; });
            select.innerHTML = options;
        }

        function saveProfile() {
            const n = document.getElementById('profileName').value.trim();
            if (n && n !== SAMPLE_KEY) { profiles[n] = JSON.parse(JSON.stringify(data)); localStorage.setItem(STORAGE_KEY_PROFILES, JSON.stringify(profiles)); updateProfileSelect(); alert("ä¿å­˜ã—ã¾ã—ãŸ"); }
        }

        function loadProfile() {
            const n = document.getElementById('profileSelect').value;
            data = JSON.parse(JSON.stringify(profiles[n] || { mains:[], sides:[], salads:[], soups:[], currentPlan: Array.from({length: 7}, () => ({ main: "", side: "", salad: "", soup: "", mainFixed: false, sideFixed: false, saladFixed: false, soupFixed: false })) }));
            renderAll(); renderTable();
        }

        function deleteProfile() {
            const n = document.getElementById('profileSelect').value;
            if (n === SAMPLE_KEY) return alert("ã‚µãƒ³ãƒ—ãƒ«ã¯å‰Šé™¤ä¸å¯");
            if (confirm(n + " å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { delete profiles[n]; localStorage.setItem(STORAGE_KEY_PROFILES, JSON.stringify(profiles)); updateProfileSelect(); }
        }

        function exportCSV() {
            let csv = "Type,Name,Ingredients\n";
            ['main', 'side', 'salad', 'soup'].forEach(t => data[t+'s'].forEach(d => csv += `${t},"${d.name}","${d.ing.join('/')}"\n`));
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "my_dishes.csv"; link.click();
        }

        function importCSV(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split(/\r?\n/);
                const newData = { mains:[], sides:[], salads:[], soups:[] };
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if (row.length < 3) continue;
                    const t = row[0].trim().toLowerCase() + 's';
                    const name = row[1].replace(/"/g, '').trim();
                    const ing = row[2].replace(/"/g, '').split('/').map(s => s.trim()).filter(s => s);
                    if (newData[t]) newData[t].push({ name, ing });
                }
                if (confirm(`èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ`)) { Object.assign(data, newData); renderAll(); renderTable(); }
                input.value = "";
            };
            reader.readAsText(file);
        }

        function clearUnfixed() {
            data.currentPlan.forEach(p => { ['main', 'side', 'salad', 'soup'].forEach(t => { if(!p[t+'Fixed']) p[t] = ""; }); });
            renderTable(); saveToLocal();
        }

        async function saveAsImage(id, name) {
            const card = document.getElementById(id);
            const links = card.querySelectorAll('.search-link');
            links.forEach(l => l.style.display = 'none');
            const canvas = await html2canvas(card, { scale: 2, backgroundColor: "#fff5f8" });
            links.forEach(l => l.style.display = 'inline-block');
            const link = document.createElement('a'); link.href = canvas.toDataURL(); link.download = `${name}.png`; link.click();
        }

        function copyText(id) {
            let txt = "";
            if (id === 'planBody') {
                txt = data.currentPlan.map((p,i) => `${DAYS[i]}: ${p.main||'-'} / ${p.side||'-'} / ${p.salad||'-'} / ${p.soup||'-'}`).join('\n');
            } else if (id === 'shoppingListBody') {
                txt = Array.from(document.getElementById(id).querySelectorAll('li')).map(li => {
                    let text = li.querySelector('span').innerText;
                    if(li.querySelector('.batch-tag')) text += ' (åœ¨åº«ã‚ã‚Š)';
                    return text;
                }).join('\n');
            }
            navigator.clipboard.writeText(txt).then(() => alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
        }

        function saveToLocal() { localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(data)); }
        init();
    </script>
</body>
</html>
