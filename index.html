
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŒ®ç«‹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ Pro V40</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <style>
        :root {
            --md-primary: #2e7d32;
            --md-surface: #f0f4ef;
            --md-secondary: #ef6c00;
            --md-error: #ba1a1a;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        body { font-family: sans-serif; background: var(--md-surface); color: #1a1c19; margin: 0; padding: 12px; padding-bottom: 60px; font-size: 14px; }
        .card { background: #fff; padding: 16px; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 16px; }
        h2 { font-size: 1rem; color: var(--md-primary); margin: 0 0 12px 0; border-left: 5px solid var(--md-primary); padding-left: 8px; }
        input[type="text"], select { width: 100%; padding: 12px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 12px; font-size: 16px; box-sizing: border-box; }
        select[multiple] { height: 100px; }
        label { display: block; margin: 8px 0 4px 4px; font-weight: bold; color: #555; font-size: 0.85rem; }
        button { background: var(--md-primary); color: white; border: none; padding: 14px; border-radius: 100px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 8px; }
        .scroll-list { max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px; padding: 8px; background: #fafafa; margin-bottom: 12px; }
        .list-item { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 8px; margin-bottom: 6px; display: flex; align-items: flex-start; gap: 8px; border-left: 4px solid var(--md-primary); }
        .edit-area { flex-grow: 1; overflow: hidden; }
        .dish-name-edit { font-weight: bold; display: block; border-bottom: 1px dashed #ddd; }
        .dish-ing-edit { font-size: 0.75rem; color: #666; }
        .switch-container { display: flex; align-items: center; justify-content: space-between; background: #e8f5e9; padding: 12px; border-radius: 16px; margin: 10px 0; font-weight: bold; }
        .switch { position: relative; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ccc; transition: .3s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background: var(--md-primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        table { width: 100%; border-collapse: collapse; background: white; border: 2px solid #ddd; table-layout: fixed; }
        tr.day-row { border-bottom: 4px solid #ccc; }
        th.day-header { width: 40px; background: #2e7d32; color: white; padding: 10px 2px; text-align: center; border-right: 1px solid #ddd; font-size: 1.1rem; }
        td.menu-content { padding: 8px; }
        .dish-section { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dotted #eee; }
        .dish-section:last-child { border-bottom: none; }
        .dish-header-row { display: flex; align-items: center; gap: 4px; margin-bottom: 4px; }
        .dish-type-label { font-size: 0.6rem; font-weight: bold; padding: 2px 4px; border-radius: 4px; color: white; }
        .label-main { background: var(--md-primary); }
        .label-side { background: var(--md-secondary); }
        .fix-btn { font-size: 0.6rem; padding: 2px 5px; border-radius: 4px; border: 1px solid #ccc; background: #fff; cursor: pointer; font-weight: bold; }
        .fix-btn.fixed { background: #333; color: #fff; border-color: #333; }
        .menu-select { flex-grow: 1; padding: 4px; font-size: 0.85rem; font-weight: bold; border: 1px solid #eee; background: #fff; max-width: 65%; }
        .ing-text { font-size: 0.7rem; color: #666; display: block; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .batch-tag { font-size: 9px; background: #e3f2fd; color: #1565c0; padding: 1px 4px; border-radius: 4px; margin-left: 4px; }
        #shoppingListCard ul { padding-left: 20px; margin: 0; }
        #shoppingListCard li { margin-bottom: 4px; }
    </style>
</head>
<body>

    <h1 style="text-align:center; color:var(--md-primary); font-size:1.4rem; margin:10px 0;">ğŸ´ çŒ®ç«‹ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ Pro</h1>

    <div class="card">
        <h2>ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†</h2>
        <select id="profileSelect"></select>
        <div class="btn-row">
            <button onclick="loadProfile()" style="background:#78909c">èª­ã¿è¾¼ã‚€</button>
            <button onclick="deleteProfile()" style="background:var(--md-error)">å‰Šé™¤</button>
        </div>
        <hr style="border:0; border-top:1px solid #eee; margin:12px 0;">
        <input type="text" id="profileName" placeholder="æ–°è¦ä¿å­˜å">
        <button onclick="saveProfile()" style="background:#006495">ç¾åœ¨ã®è¨­å®šã‚’ä¿å­˜</button>
        
        <div class="btn-row">
            <button onclick="exportCSV()" style="background:#455a64; font-size:0.8rem;">CSVå‡ºåŠ› (ä¿å­˜ç”¨)</button>
            <button onclick="document.getElementById('csvInput').click()" style="background:#455a64; font-size:0.8rem;">CSVå…¥åŠ› (å¾©å…ƒç”¨)</button>
            <input type="file" id="csvInput" style="display:none" accept=".csv" onchange="importCSV(this)">
        </div>
    </div>

    <div class="card">
        <h2>æ–™ç†ã®ç™»éŒ² (å…¨ä»¶è¡¨ç¤º)</h2>
        <div class="btn-row" style="margin-top:0; margin-bottom:12px;">
            <input type="text" id="addName" placeholder="æ–™ç†å">
            <input type="text" id="addIng" placeholder="ææ–™">
        </div>
        <div class="btn-row" style="margin-top:0; margin-bottom:12px;">
            <button onclick="addDish('main')">ä¸»èœã¸è¿½åŠ </button>
            <button onclick="addDish('side')" style="background:var(--md-secondary)">å‰¯èœã¸è¿½åŠ </button>
        </div>
        <label>ä¸»èœãƒªã‚¹ãƒˆ</label><div id="mainListDisplay" class="scroll-list"></div>
        <label>å‰¯èœãƒªã‚¹ãƒˆ</label><div id="sideListDisplay" class="scroll-list"></div>
    </div>

    <div class="card">
        <h2>ä½œæˆæ¡ä»¶</h2>
        <label>ğŸ  åœ¨åº«ã«ã‚ã‚‹é£Ÿæ</label><select id="inventorySelect" multiple></select>
        <label>âŒ é£Ÿã¹ãŸããªã„æ–™ç†</label><select id="excludeSelect" multiple></select>
        <label>â­ é£Ÿã¹ãŸã„æ–™ç†</label><select id="wantToEatSelect" multiple></select>
        <div class="switch-container">
            <span>åœ¨åº«é£Ÿæã‚’å„ªå…ˆæ´»ç”¨</span>
            <label class="switch"><input type="checkbox" id="priorityMode" checked><span class="slider"></span></label>
        </div>
        <button onclick="generatePlan()" style="height:60px; font-size:1.1rem;">çŒ®ç«‹ã‚’è‡ªå‹•ä½œæˆ</button>
    </div>

    <div class="card" id="planCard">
        <h2>ğŸ“… ä»Šé€±ã®çŒ®ç«‹</h2>
        <table><tbody id="planBody"></tbody></table>
        <div class="btn-row">
            <button onclick="clearUnfixed()" style="background:#78909c">å›ºå®šä»¥å¤–ã‚’ã‚¯ãƒªã‚¢</button>
            <button onclick="copyText('planBody')" style="background:#546e7a">ã‚³ãƒ”ãƒ¼</button>
        </div>
        <button onclick="saveAsImage('planCard', 'ä»Šé€±ã®çŒ®ç«‹')" style="background:#4527a0; margin-top:8px;">ç”»åƒä¿å­˜</button>
    </div>

    <div class="card" id="shoppingListCard">
        <h2>ğŸ›’ è²·ã„ç‰©ãƒªã‚¹ãƒˆï¼ˆææ–™ï¼‰</h2>
        <ul id="shoppingListBody"></ul>
        <div class="btn-row" style="margin-top:12px;">
            <button onclick="copyText('shoppingListBody')" style="background:#546e7a">ãƒªã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
            <button onclick="saveAsImage('shoppingListCard', 'è²·ã„ç‰©ãƒªã‚¹ãƒˆ')" style="background:#4527a0">ç”»åƒä¿å­˜</button>
        </div>
    </div>

    <script>
        const STORAGE_KEY_DATA = 'Kondate_V40_Data';
        const STORAGE_KEY_PROFILES = 'Kondate_V40_Profiles';
        const SAMPLE_KEY = "ã‚µãƒ³ãƒ—ãƒ«(å®šç•ª)";
        const DAYS = ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"];

        const MASTER_SAMPLE = {
            mains: [{name:"ã‚«ãƒ¬ãƒ¼",ing:["è±šè‚‰","ç‰ã­ã","äººå‚"]},{name:"ãƒãƒ³ãƒãƒ¼ã‚°",ing:["åˆæŒ½è‚‰","ç‰ã­ã"]},{name:"å”æšã’",ing:["é¶ã‚‚ã‚‚è‚‰","ç”Ÿå§œ"]},{name:"é¯–ã®å‘³å™Œç…®",ing:["é¯–","å‘³å™Œ"]},{name:"ç”Ÿå§œç„¼ã",ing:["è±šè‚‰","ç‰ã­ã"]},{name:"è‚‰ã˜ã‚ƒãŒ",ing:["ç‰›è‚‰","ã˜ã‚ƒãŒã„ã‚‚"]},{name:"éº»å©†è±†è…",ing:["è±†è…","è±šæŒ½è‚‰"]},{name:"é‡èœç‚’ã‚",ing:["è±šè‚‰","ã‚­ãƒ£ãƒ™ãƒ„"]},{name:"è¦ªå­ä¸¼",ing:["é¶è‚‰","åµ","ç‰ã­ã"]},{name:"ã¨ã‚“ã‹ã¤",ing:["è±šãƒ­ãƒ¼ã‚¹è‚‰"]},{name:"é¤ƒå­",ing:["è±šæŒ½è‚‰","ç™½èœ","ãƒ‹ãƒ©"]},{name:"é®­ã®ãƒ ãƒ‹ã‚¨ãƒ«",ing:["é®­"]},{name:"ç­‘å‰ç…®",ing:["é¶è‚‰","ã”ã¼ã†","è“®æ ¹"]},{name:"ã‚ªãƒ ãƒ©ã‚¤ã‚¹",ing:["åµ","é¶è‚‰","ç‰ã­ã"]},{name:"ç‰›ä¸¼",ing:["ç‰›è‚‰","ç‰ã­ã"]},{name:"ç„¼ããã°",ing:["è±šè‚‰","ã‚­ãƒ£ãƒ™ãƒ„","éºº"]},{name:"ã‚°ãƒ©ã‚¿ãƒ³",ing:["ãƒã‚«ãƒ­ãƒ‹","é¶è‚‰","ç‰›ä¹³"]},{name:"ã‚¯ãƒªãƒ¼ãƒ ã‚·ãƒãƒ¥ãƒ¼",ing:["é¶è‚‰","ã˜ã‚ƒãŒã„ã‚‚"]},{name:"ç…§ã‚Šç„¼ããƒã‚­ãƒ³",ing:["é¶ã‚‚ã‚‚è‚‰"]},{name:"ç„¼å£²",ing:["è±šæŒ½è‚‰","ç‰ã­ã"]}],
            sides: [{name:"ãƒãƒ†ãƒˆã‚µãƒ©ãƒ€",ing:["ã˜ã‚ƒãŒã„ã‚‚","ãã‚…ã†ã‚Š"]},{name:"ã»ã†ã‚Œã‚“è‰ãŠæµ¸ã—",ing:["ã»ã†ã‚Œã‚“è‰"]},{name:"å†·å¥´",ing:["è±†è…","ã­ã"]},{name:"å‘³å™Œæ±",ing:["è±†è…","ã‚ã‹ã‚"]},{name:"ãã‚“ã´ã‚‰ã”ã¼ã†",ing:["ã”ã¼ã†","äººå‚"]},{name:"ã²ã˜ãç…®",ing:["ã²ã˜ã","å¤§è±†"]},{name:"åˆ‡ã‚Šå¹²ã—å¤§æ ¹",ing:["åˆ‡ã‚Šå¹²ã—å¤§æ ¹"]},{name:"ãƒŠãƒ ãƒ«",ing:["ã‚‚ã‚„ã—","ã»ã†ã‚Œã‚“è‰"]},{name:"ãã‚…ã†ã‚Šã®é…¢ã®ç‰©",ing:["ãã‚…ã†ã‚Š","ã‚ã‹ã‚"]},{name:"ã ã—å·»ãåµ",ing:["åµ"]},{name:"ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼ã‚µãƒ©ãƒ€",ing:["ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼"]},{name:"ãƒã‚«ãƒ­ãƒ‹ã‚µãƒ©ãƒ€",ing:["ãƒã‚«ãƒ­ãƒ‹"]},{name:"æµ…æ¼¬ã‘",ing:["ç™½èœ","ãã‚…ã†ã‚Š"]},{name:"èŒ„å­ã®æšã’æµ¸ã—",ing:["èŒ„å­"]},{name:"ã‹ã¼ã¡ã‚ƒã®ç…®ç‰©",ing:["ã‹ã¼ã¡ã‚ƒ"]},{name:"ã‚³ãƒ¼ãƒ«ã‚¹ãƒ­ãƒ¼",ing:["ã‚­ãƒ£ãƒ™ãƒ„"]},{name:"èŒ¶ç¢—è’¸ã—",ing:["åµ","é¶è‚‰"]},{name:"èƒ¡éº»å’Œãˆ",ing:["ã„ã‚“ã’ã‚“"]},{name:"ãƒˆãƒãƒˆã‚µãƒ©ãƒ€",ing:["ãƒˆãƒãƒˆ"]},{name:"è±šæ±",ing:["è±šè‚‰","å¤§æ ¹","äººå‚"]}],
            currentPlan: Array.from({length: 7}, () => ({ main: "", side: "", mainFixed: false, sideFixed: false }))
        };

        let profiles = JSON.parse(localStorage.getItem(STORAGE_KEY_PROFILES)) || {};
        let data = JSON.parse(localStorage.getItem(STORAGE_KEY_DATA)) || JSON.parse(JSON.stringify(MASTER_SAMPLE));

        function init() {
            ensureSampleExists();
            updateProfileSelect();
            renderAll();
            renderTable();
        }

        function ensureSampleExists() {
            // ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å†…ã«ã€Œã‚µãƒ³ãƒ—ãƒ«(å®šç•ª)ã€ãŒå­˜åœ¨ã—ãªã‘ã‚Œã°å¼·åˆ¶çš„ã«ä½œã‚‹
            if (!profiles[SAMPLE_KEY]) {
                profiles[SAMPLE_KEY] = JSON.parse(JSON.stringify(MASTER_SAMPLE));
                localStorage.setItem(STORAGE_KEY_PROFILES, JSON.stringify(profiles));
            }
        }

        function renderAll() {
            renderFullList('main');
            renderFullList('side');
            updateSelectors();
            localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(data));
        }

        function renderFullList(type) {
            const list = type === 'main' ? data.mains : data.sides;
            const container = document.getElementById(type + 'ListDisplay');
            container.innerHTML = list.map((d, i) => `
                <div class="list-item" style="border-left-color:${type==='main'?'#2e7d32':'#ef6c00'}">
                    <div class="edit-area">
                        <span class="dish-name-edit" contenteditable="true" onblur="updateDishData('${type}',${i},'name',this)">${d.name}</span>
                        <span class="dish-ing-edit" contenteditable="true" onblur="updateDishData('${type}',${i},'ing',this)">${d.ing.join('ã€')}</span>
                    </div>
                    <span style="color:red; cursor:pointer;" onclick="deleteDish('${type}',${i})">âœ•</span>
                </div>`).join('');
        }

        function updateDishData(t, i, f, el) {
            const val = el.innerText.trim();
            if (f === 'name') data[t + 's'][i].name = val;
            else data[t + 's'][i].ing = val.split(/[ã€,]+/).map(s => s.trim());
            renderAll(); renderTable();
        }

        function addDish(t) {
            const n = document.getElementById('addName').value.trim();
            const g = document.getElementById('addIng').value.split(/[ã€,]+/).map(s => s.trim()).filter(s => s);
            if (n) { data[t + 's'].push({ name: n, ing: g }); renderAll(); renderTable(); }
            document.getElementById('addName').value = ''; document.getElementById('addIng').value = '';
        }

        function deleteDish(t, i) { data[t + 's'].splice(i, 1); renderAll(); renderTable(); }

        function updateSelectors() {
            const allIng = [...new Set([...data.mains.flatMap(d => d.ing), ...data.sides.flatMap(d => d.ing)])].sort();
            const allNames = [...data.mains.map(d => d.name), ...data.sides.map(d => d.name)].sort();
            document.getElementById('inventorySelect').innerHTML = allIng.map(i => `<option value="${i}">${i}</option>`).join('');
            document.getElementById('excludeSelect').innerHTML = allNames.map(n => `<option value="${n}">${n}</option>`).join('');
            document.getElementById('wantToEatSelect').innerHTML = allNames.map(n => `<option value="${n}">${n}</option>`).join('');
        }

        function renderTable() {
            let html = "";
            DAYS.forEach((day, i) => {
                const p = data.currentPlan[i] || { main: "", side: "", mainFixed: false, sideFixed: false };
                const mDish = data.mains.find(d => d.name === p.main) || {name:"", ing:[]};
                const sDish = data.sides.find(d => d.name === p.side) || {name:"", ing:[]};
                html += `<tr class="day-row">
                    <th class="day-header">${day}</th>
                    <td class="menu-content">
                        <div class="dish-section">
                            <div class="dish-header-row">
                                <span class="dish-type-label label-main">ä¸»èœ</span>
                                <span class="fix-btn ${p.mainFixed?'fixed':''}" onclick="toggleFix(${i},'main')">${p.mainFixed?'å›ºå®šä¸­':'å›ºå®š'}</span>
                                <select class="menu-select" onchange="updateChoice(${i},'main',this.value)">
                                    <option value="">æœªè¨­å®š</option>
                                    ${data.mains.map(d => `<option value="${d.name}" ${d.name===p.main?'selected':''}>${d.name}</option>`).join('')}
                                </select>
                            </div>
                            <small class="ing-text">${mDish.ing.join(',')}</small>
                        </div>
                        <div class="dish-section">
                            <div class="dish-header-row">
                                <span class="dish-type-label label-side">å‰¯èœ</span>
                                <span class="fix-btn ${p.sideFixed?'fixed':''}" onclick="toggleFix(${i},'side')">${p.sideFixed?'å›ºå®šä¸­':'å›ºå®š'}</span>
                                <select class="menu-select" onchange="updateChoice(${i},'side',this.value)">
                                    <option value="">æœªè¨­å®š</option>
                                    ${data.sides.map(d => `<option value="${d.name}" ${d.name===p.side?'selected':''}>${d.name}</option>`).join('')}
                                </select>
                            </div>
                            <small class="ing-text">${sDish.ing.join(',')}</small>
                        </div>
                    </td>
                </tr>`;
            });
            document.getElementById('planBody').innerHTML = html;
            updateShoppingList();
        }

        function toggleFix(i, type) { 
            if(type === 'main') data.currentPlan[i].mainFixed = !data.currentPlan[i].mainFixed;
            else data.currentPlan[i].sideFixed = !data.currentPlan[i].sideFixed;
            renderTable(); saveToLocal(); 
        }

        function updateChoice(i, type, val) { data.currentPlan[i][type] = val; renderTable(); saveToLocal(); }

        function generatePlan() {
            const inv = Array.from(document.getElementById('inventorySelect').selectedOptions).map(o => o.value);
            const exc = Array.from(document.getElementById('excludeSelect').selectedOptions).map(o => o.value);
            const want = Array.from(document.getElementById('wantToEatSelect').selectedOptions).map(o => o.value);
            const prio = document.getElementById('priorityMode').checked;
            let mPool = shuffle([...data.mains]).filter(d => !exc.includes(d.name));
            let usedMains = data.currentPlan.filter(p => p.mainFixed && p.main).map(p => p.main);
            DAYS.forEach((_, i) => {
                if (!data.currentPlan[i].mainFixed) {
                    const m = pickDish(mPool.filter(d => !usedMains.includes(d.name)), want, inv, prio);
                    data.currentPlan[i].main = m.name;
                    if(m.name) usedMains.push(m.name);
                }
            });
            let sPool = shuffle([...data.sides]).filter(d => !exc.includes(d.name));
            let currentBatchSide = "";
            DAYS.forEach((_, i) => {
                if (i % 3 === 0) {
                    currentBatchSide = data.currentPlan[i].sideFixed ? data.currentPlan[i].side : pickDish(sPool, want, inv, prio).name;
                }
                if (!data.currentPlan[i].sideFixed) data.currentPlan[i].side = currentBatchSide;
            });
            renderTable(); saveToLocal();
        }

        function pickDish(pool, want, inv, prio) {
            if (!pool.length) return {name:"", ing:[]};
            let f = pool.filter(d => want.includes(d.name));
            if (!f.length && prio) f = pool.filter(d => d.ing.some(i => inv.includes(i)));
            return (f.length ? f : pool)[0];
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function updateShoppingList() {
            const inv = Array.from(document.getElementById('inventorySelect').selectedOptions).map(o => o.value);
            let ings = new Set();
            data.currentPlan.forEach(p => {
                const mDish = data.mains.find(d => d.name === p.main);
                const sDish = data.sides.find(d => d.name === p.side);
                if(mDish) mDish.ing.forEach(i => ings.add(i));
                if(sDish) sDish.ing.forEach(i => ings.add(i));
            });
            document.getElementById('shoppingListBody').innerHTML = Array.from(ings).sort().map(ing => `<li>${ing}${inv.includes(ing) ? ' <span class="batch-tag">åœ¨åº«ã‚ã‚Š</span>' : ''}</li>`).join('');
        }

        function updateProfileSelect() {
            ensureSampleExists();
            const select = document.getElementById('profileSelect');
            let options = `<option value="${SAMPLE_KEY}">${SAMPLE_KEY}</option>`;
            Object.keys(profiles).forEach(name => { if (name !== SAMPLE_KEY) options += `<option value="${name}">${name}</option>`; });
            select.innerHTML = options;
        }

        function saveProfile() {
            const n = document.getElementById('profileName').value.trim();
            if (n && n !== SAMPLE_KEY) { 
                profiles[n] = JSON.parse(JSON.stringify(data)); 
                localStorage.setItem(STORAGE_KEY_PROFILES, JSON.stringify(profiles)); 
                updateProfileSelect(); alert("ä¿å­˜ã—ã¾ã—ãŸ"); 
            }
        }

        function loadProfile() {
            const n = document.getElementById('profileSelect').value;
            // ã‚µãƒ³ãƒ—ãƒ«èª­ã¿è¾¼ã¿æ™‚ã‚‚å¿…ãšãƒã‚¹ã‚¿ãƒ¼ã‹ã‚‰ã‚³ãƒ”ãƒ¼
            data = JSON.parse(JSON.stringify(profiles[n] || MASTER_SAMPLE));
            renderAll(); renderTable();
        }

        function deleteProfile() {
            const n = document.getElementById('profileSelect').value;
            if (n === SAMPLE_KEY) return alert("ã‚µãƒ³ãƒ—ãƒ«ã¯å‰Šé™¤ã§ãã¾ã›ã‚“");
            if (confirm(n + " ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { 
                delete profiles[n]; 
                localStorage.setItem(STORAGE_KEY_PROFILES, JSON.stringify(profiles)); 
                updateProfileSelect(); 
            }
        }

        function exportCSV() {
            let csv = "Type,Name,Ingredients\n";
            data.mains.forEach(d => csv += `main,"${d.name}","${d.ing.join(',')}"\n`);
            data.sides.forEach(d => csv += `side,"${d.name}","${d.ing.join(',')}"\n`);
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "my_dishes.csv";
            link.click();
        }

        function importCSV(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split(/\r?\n/);
                const newMains = [];
                const newSides = [];
                for (let i = 1; i < lines.length; i++) {
                    const row = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if (row.length < 3) continue;
                    const type = row[0].trim();
                    const name = row[1].replace(/"/g, '').trim();
                    const ing = row[2].replace(/"/g, '').split(',').map(s => s.trim()).filter(s => s);
                    if (type === 'main') newMains.push({ name, ing });
                    else if (type === 'side') newSides.push({ name, ing });
                }
                if (newMains.length || newSides.length) {
                    if (confirm(`ä¸»èœ${newMains.length}ä»¶ã€å‰¯èœ${newSides.length}ä»¶ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚ç¾åœ¨ã®ãƒªã‚¹ãƒˆã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) {
                        data.mains = newMains;
                        data.sides = newSides;
                        renderAll(); renderTable();
                        alert("èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¾ã—ãŸ");
                    }
                }
                input.value = "";
            };
            reader.readAsText(file);
        }

        function clearUnfixed() {
            data.currentPlan.forEach(p => { if(!p.mainFixed) p.main = ""; if(!p.sideFixed) p.side = ""; });
            renderTable(); saveToLocal();
        }

        async function saveAsImage(id, name) {
            const canvas = await html2canvas(document.getElementById(id), { scale: 2 });
            const link = document.createElement('a'); link.href = canvas.toDataURL(); link.download = `${name}.png`; link.click();
        }

        function copyText(id) {
            let txt = "";
            if (id === 'planBody') {
                txt = data.currentPlan.map((p,i) => `${DAYS[i]}: ${p.main||'æœªè¨­å®š'} / ${p.side||'æœªè¨­å®š'}`).join('\n');
            } else if (id === 'shoppingListBody') {
                txt = Array.from(document.getElementById(id).querySelectorAll('li')).map(li => li.innerText.replace(' åœ¨åº«ã‚ã‚Š', '')).join('\n');
            } else {
                txt = document.getElementById(id).innerText;
            }
            navigator.clipboard.writeText(txt).then(() => alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
        }

        function saveToLocal() { localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(data)); }

        init();
    </script>
</body>
</html>
