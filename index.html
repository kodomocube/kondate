<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çŒ®ç«‹ï¼†è²·ã„ç‰©ãƒªã‚¹ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <style>
        :root {
            --md-primary: #ff9ecd;
            --md-surface: #fff5f8;
            --md-secondary: #ffcc80;
            --md-salad: #c5e1a5;
            --md-soup: #ce93d8;
            --md-error: #ff5252;
        }
        body { font-family: 'Hiragino Sans', sans-serif; background: var(--md-surface); color: #5d4037; margin: 0; padding: 12px; padding-bottom: 60px; font-size: 14px; }
        .header-img-container { text-align: center; margin: 10px 0; }
        .header-img { width: 100%; max-width: 320px; border-radius: 25px; box-shadow: 0 8px 15px rgba(255, 158, 205, 0.3); }
        .card { background: #fff; padding: 16px; border-radius: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 16px; border: 2px solid #fff; }

        .details-content { padding-top: 15px; }

        button {
            position: relative; border: none; padding: 14px 20px; border-radius: 100px; font-weight: bold; width: 100%; cursor: pointer; margin-bottom: 12px; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); overflow: hidden; transition: transform 0.1s;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1), 0 8px 15px rgba(0,0,0,0.1), inset 0 -6px 8px rgba(0,0,0,0.2), inset 0 4px 8px rgba(255,255,255,0.4);
        }
        button::after { content: ""; position: absolute; top: 4px; left: 15%; width: 70%; height: 35%; background: linear-gradient(to bottom, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 100%); border-radius: 100px; pointer-events: none; }
        button:active { transform: translateY(3px); box-shadow: 0 2px 0 rgba(0,0,0,0.1), inset 0 -3px 5px rgba(0,0,0,0.2), inset 0 4px 8px rgba(255,255,255,0.4); }

        .btn-main { background: linear-gradient(#ff9ecd, #ff69b4); }
        .btn-side { background: linear-gradient(#ffcc80, #ffa726); }
        .btn-salad { background: linear-gradient(#c5e1a5, #9ccc65); }
        .btn-soup { background: linear-gradient(#ce93d8, #ab47bc); }
        .btn-load { background: linear-gradient(#ce93d8, #ab47bc); }
        .btn-delete { background: linear-gradient(#ef9a9a, #e57373); }
        .btn-save { background: linear-gradient(#90caf9, #42a5f5); }
        .btn-csv { background: linear-gradient(#b0bec5, #78909c); }
        .btn-image { background: linear-gradient(#ff8aab, #f44336); }
        .btn-line { background: linear-gradient(#06C755, #05b34c); }

        .glossy-card { background: #ffffff !important; border: 3px solid #fff !important; box-shadow: 0 10px 25px rgba(255, 182, 193, 0.4) !important; position: relative; }

        h2 { font-size: 1.1rem; color: #ff69b4; text-shadow: 1px 1px 0 #fff; }
        input[type="text"], select { width: 100%; padding: 12px; margin-bottom: 8px; border: 2px solid #ffe0ea; border-radius: 20px; font-size: 16px; box-sizing: border-box; background: #fff; }

        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; table-layout: fixed; }
        th.day-header { width: 35px; background: #ff9ecd; color: white; border-radius: 15px 0 0 15px; text-shadow: 1px 1px 0 rgba(0,0,0,0.1); }
        td.menu-content { padding: 8px; background: white; border-radius: 0 15px 15px 0; border: 2px solid #fff; }
        
        .day-row-0 th.day-header { background-color: #fdd835 !important; }
        .day-row-1 th.day-header { background-color: #ef5350 !important; }
        .day-row-2 th.day-header { background-color: #4fc3f7 !important; }
        .day-row-3 th.day-header { background-color: #81c784 !important; }
        .day-row-4 th.day-header { background-color: #f06292 !important; }
        .day-row-5 th.day-header { background-color: #5c6bc0 !important; }
        .day-row-6 th.day-header { background-color: #d32f2f !important; }

        .dish-section { margin-bottom: 12px; padding: 8px; background: #fff9fb; border-radius: 15px; border: 1px solid #ffebee; }
        .dish-header-row { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 4px; }
        
        .dish-type-label { font-size: 0.6rem; font-weight: bold; padding: 2px 8px; border-radius: 20px; color: white; text-align: center; min-width: 40px; }
        .label-main { background-color: #f06292; }
        .label-side { background-color: #ffb74d; }
        .label-salad { background-color: #aed581; }
        .label-soup { background-color: #9575cd; }

        .fix-btn { font-size: 0.6rem; padding: 4px 10px; border-radius: 20px; border: 1px solid #ffc1e3; background: #fff; color: #f06292; font-weight: bold; min-width: 60px; text-align: center; cursor: pointer; }
        .fix-btn.fixed { background: #f06292; color: #fff; }
        
        .menu-select { width: 100% !important; flex: 0 0 100%; margin-top: 4px; padding: 8px; font-size: 0.9rem; border: 1px solid #ffd1dc; border-radius: 10px; color: #880e4f; background: #fff; box-sizing: border-box; }
        .search-link { text-decoration: none; font-size: 0.65rem; background: #fff; padding: 3px 8px; border-radius: 10px; color: #f06292; border: 1px solid #ffc1e3; font-weight: bold; white-space: nowrap; }

        #shoppingListBody { list-style: none; padding: 0; }
        #shoppingListBody li { background: #fff; margin-bottom: 8px; padding: 12px; border-radius: 20px; border: 2px solid #fff; box-shadow: 0 4px 8px rgba(255,182,193,0.3); display: flex; align-items: center; justify-content: space-between; color: #d81b60; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        #shoppingListBody li.checked { background: #eeeeee !important; color: #9e9e9e !important; text-decoration: line-through; box-shadow: none; border: 2px solid #ddd; }
        #shoppingListBody li.checked .batch-tag { background: #bdbdbd !important; color: #fff !important; }

        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
        .scroll-list { max-height: 200px; overflow-y: auto; border: 2px solid #ffe0ea; border-radius: 18px; padding: 8px; background: #fff; margin-bottom: 12px; }
        .list-item { background: #fffaf0; border: 1px solid #ffecb3; border-radius: 15px; padding: 8px; margin-bottom: 6px; display: flex; align-items: flex-start; gap: 8px; border-left: 6px solid #ffcc80; }

        /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºã®æ™‚ã®åˆ¶å¾¡ */
        .compact-mode#planCard .dish-section { display: none !important; }
        .compact-mode#planCard .drop-row { display: flex; margin-bottom: 4px; }
        .compact-mode#planCard .drop-row:last-child { margin-bottom: 0; }
        
        /* è©³ç´°è¡¨ç¤ºã®æ™‚ã®åˆ¶å¾¡ */
        #planCard:not(.compact-mode) .drop-row { display: none !important; }

        /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºæ™‚ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        .compact-mode#planCard table { border-spacing: 0; border: 1px solid #ffd1dc; border-radius: 15px; overflow: hidden; background: #fff; }
        .compact-mode#planCard th.day-header { width: 35px; font-size: 14px; border-radius: 0; border-right: 1px solid #ffd1dc; color: white !important; }
        .compact-mode#planCard td.menu-content { padding: 4px 8px; border-radius: 0; border-bottom: 2px solid #ffe0ea; display: flex; flex-direction: column; background: #fff !important; }
        .compact-mode#planCard .day-row:last-child td { border-bottom: none; }
        
        .drop-row { gap: 4px; width: 100%; }
        .drop-badge { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4px 4px; border-radius: 12px; color: white !important; flex: 1; min-height: 40px; position: relative; text-align: center; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; }
        .drop-badge .dish-name { font-size: 11px; font-weight: bold; line-height: 1.1; margin-bottom: 2px; }
        .drop-badge .dish-ings { font-size: 8px; line-height: 1; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 95%; }
        .drop-badge::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 40%; background: rgba(255,255,255,0.15); pointer-events: none; }
        
        .toggle-compact-btn { width: auto; padding: 6px 12px; font-size: 0.7rem; margin-bottom: 0; background: linear-gradient(#f06292, #e91e63); display: inline-block; vertical-align: middle; }
        .batch-action-btn { font-size: 0.7rem; padding: 8px 10px; border-radius: 100px; width: 100%; font-weight: bold; color: white; cursor: pointer; margin-bottom: 0; }
        .btn-salad-action { background: linear-gradient(#c5e1a5, #8bc34a); }
        .btn-soup-action { background: linear-gradient(#ce93d8, #9c27b0); }
        
        .order-toggle-btn { width: auto; padding: 8px 16px; font-size: 0.9rem; margin-bottom: 0; display: inline-block; color: #fff !important; }
        .order-on { background: linear-gradient(#e65100, #bf360c); box-shadow: 0 4px 0 #870000; }
        .order-off { background: linear-gradient(#9e9e9e, #616161); box-shadow: 0 4px 0 #424242; }
        .btn-reset-list { width: auto; padding: 6px 12px; font-size: 0.75rem; background: linear-gradient(#78909c, #455a64); margin-top: 8px; }
        .order-def { font-size: 0.75rem; color: #555; margin-top: 10px; padding: 10px; background: #fdfdfd; border: 1px solid #eee; border-radius: 12px; line-height: 1.5; }

        #dishPickerOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: flex-end; }
        #dishPickerContent { background: white; width: 100%; max-width: 500px; border-radius: 25px 25px 0 0; padding: 20px; box-sizing: border-box; max-height: 80%; overflow-y: auto; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .picker-title { font-weight: bold; color: #ff69b4; margin-bottom: 10px; text-align: center; font-size: 1.1rem; }
        .picker-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .picker-btn { background: #fff; border: 2px solid #ffe0ea; padding: 12px; border-radius: 15px; text-align: center; color: #5d4037; font-weight: bold; cursor: pointer; transition: background 0.2s; word-break: break-all; }
        .picker-btn:active { background: #ffe0ea; }
        .picker-btn.none { grid-column: span 2; background: #f5f5f5; color: #888; border-color: #ddd; }
        
        .fix-toggle-panel { background: #fff0f5; padding: 12px; border-radius: 15px; margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; border: 2px solid #ffc1e3; cursor: pointer; }
        .fix-status-label { font-weight: bold; color: #f06292; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="header-img-container"><img src="cookingtitle.png" alt="Kodomo Cube" class="header-img"></div>
    <h1 style="text-align:center; color:#ff69b4; font-size:1.4rem; margin:10px 0; text-shadow: 2px 2px 0 #fff;">ğŸ€ çŒ®ç«‹ï¼†è²·ã„ç‰©ãƒªã‚¹ãƒˆãƒ¡ãƒ¼ã‚«ãƒ¼</h1>

    <div class="card">
        <details><summary><h2 style="display:inline">ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†</h2></summary>
            <div class="details-content">
                <select id="profileSelect"></select>
                <div class="btn-row">
                    <button class="btn-load" onclick="loadProfile()">èª­ã¿è¾¼ã‚€</button>
                    <button class="btn-delete" onclick="deleteProfile()">å‰Šé™¤</button>
                </div>
                <hr style="border:0; border-top:2px dashed #ffe0ea; margin:12px 0;">
                <input type="text" id="profileName" placeholder="æ–°è¦ä¿å­˜å">
                <button class="btn-save" onclick="saveProfile()">ä¿å­˜</button>
                <div class="btn-row">
                    <button class="btn-csv" onclick="exportCSV()">CSVå‡ºåŠ›</button>
                    <button class="btn-csv" onclick="document.getElementById('csvInput').click()">CSVå…¥åŠ›</button>
                    <input type="file" id="csvInput" style="display:none" accept=".csv" onchange="importCSV(this)">
                </div>
            </div>
        </details>
    </div>

    <div class="card">
        <details><summary><h2 style="display:inline">æ–™ç†ã®ç™»éŒ²</h2></summary>
            <div class="details-content">
                <div class="btn-row"><input type="text" id="addName" placeholder="æ–™ç†å"><input type="text" id="addIng" placeholder="ææ–™"></div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px;">
                    <button class="btn-main" onclick="addDish('main')">ä¸»èœè¿½åŠ </button>
                    <button class="btn-side" onclick="addDish('side')">å‰¯èœè¿½åŠ </button>
                    <button class="btn-salad" onclick="addDish('salad')">ã‚µãƒ©ãƒ€è¿½åŠ </button>
                    <button class="btn-soup" onclick="addDish('soup')">ã‚¹ãƒ¼ãƒ—è¿½åŠ </button>
                </div>
                <label>ä¸»èœ</label><div id="mainListDisplay" class="scroll-list"></div>
                <label>å‰¯èœ</label><div id="sideListDisplay" class="scroll-list"></div>
                <label>ã‚µãƒ©ãƒ€</label><div id="saladListDisplay" class="scroll-list"></div>
                <label>ã‚¹ãƒ¼ãƒ—</label><div id="soupListDisplay" class="scroll-list"></div>
            </div>
        </details>
    </div>

    <div class="card">
        <h2>ä½œæˆæ¡ä»¶</h2>
        <label>ğŸ  åœ¨åº«ã«ã‚ã‚‹é£Ÿæ</label><select id="inventorySelect" multiple></select>
        <div style="background: #fff0f5; border: 2px solid #ffe0ea; border-radius: 20px; padding: 12px; margin: 10px 0;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span>åœ¨åº«é£Ÿæã‚’å„ªå…ˆæ´»ç”¨</span><input type="checkbox" id="priorityMode" checked>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span>å‰¯èœ: ä½œã‚Šç½®ãæ—¥æ•°</span>
                <select id="sideBatchDays" style="width: auto; margin-bottom: 0;">
                    <option value="1">1æ—¥ (æ¯æ—¥å¤‰ãˆã‚‹)</option>
                    <option value="2">2æ—¥</option>
                    <option value="3" selected>3æ—¥</option>
                    <option value="4">4æ—¥</option>
                    <option value="5">5æ—¥</option>
                    <option value="6">6æ—¥</option>
                    <option value="7">7æ—¥ (1é€±é–“åŒã˜)</option>
                </select>
            </div>
        </div>
        <label>â­•ï¸ é£Ÿã¹ãŸã„æ–™ç†</label><select id="wantToEatSelect" multiple></select>
        <label>âŒ é£Ÿã¹ãŸããªã„æ–™ç†</label><select id="excludeSelect" multiple></select>
        <button class="btn-main" style="height:70px; font-size:1.1rem;" onclick="generatePlan()">å›ºå®šã—ã¦ã„ãªã„çŒ®ç«‹ã‚’è‡ªå‹•ä½œæˆ</button>
    </div>

    <div class="card glossy-card compact-mode" id="planCard">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0;">ğŸ“… ä»Šé€±ã®çŒ®ç«‹</h2>
            <button class="toggle-compact-btn" onclick="toggleCompact()">è©³ç´°è¡¨ç¤ºã«ã™ã‚‹</button>
        </div>
        <div class="btn-row" style="margin-bottom:12px;">
            <button class="batch-action-btn btn-salad-action" id="batchSaladBtn" onclick="toggleBatchClear('salad')">ä¸€æ‹¬ã§ã‚µãƒ©ãƒ€ã‚’ãªã—ã«ã™ã‚‹</button>
            <button class="batch-action-btn btn-soup-action" id="batchSoupBtn" onclick="toggleBatchClear('soup')">ä¸€æ‹¬ã§ã‚¹ãƒ¼ãƒ—ã‚’ãªã—ã«ã™ã‚‹</button>
        </div>
        <table><tbody id="planBody"></tbody></table>
        <div class="btn-row">
            <button class="btn-load" onclick="clearUnfixed()">å›ºå®šä»¥å¤–ã‚¯ãƒªã‚¢</button>
            <button class="btn-save" onclick="copyText('planBody')">ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼</button>
        </div>
        <div class="btn-row">
            <button class="btn-image" onclick="saveAsImage('planCard', 'ä»Šé€±ã®çŒ®ç«‹')">ç”»åƒä¿å­˜</button>
            <button class="btn-line" onclick="shareAsImage('planCard', 'ä»Šé€±ã®çŒ®ç«‹')">ç”»åƒã‚’LINEç­‰ã§é€ã‚‹</button>
        </div>
    </div>

    <div class="card glossy-card" id="shoppingListCard">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h2 style="margin:0;">ğŸ›’ è²·ã„ç‰©ãƒªã‚¹ãƒˆ</h2>
            <button class="order-toggle-btn order-on" id="orderToggle" onclick="toggleOrder()">é™³åˆ—é †: ON</button>
        </div>
        <p style="font-size: 0.75rem; color: #ff69b4; margin: 0 0 8px 4px; font-weight: bold;">â€»ã‚¿ãƒƒãƒ—ã§è³¼å…¥æ¸ˆã¿(æ‰“ã¡æ¶ˆã—ç·š)ã«ã§ãã¾ã™</p>
        <button class="btn-reset-list" onclick="resetShoppingCheck()">è³¼å…¥æ¸ˆã¿ãƒªã‚»ãƒƒãƒˆ</button>
        <ul id="shoppingListBody"></ul>
        <div class="order-def" id="orderDef">
            <b>ã€é™³åˆ—é †ã®å®šç¾©ã€‘</b><br>
            é‡èœãƒ»æœç‰© â” è‚‰ â” é­š â” ä¹³è£½å“ãƒ»è±†è…ãƒ»ç´è±† â” å†·å‡ãƒ»åŠ å·¥é£Ÿå“ â” èª¿å‘³æ–™ãƒ»ãã®ä»–
        </div>
        <div class="btn-row">
            <button class="btn-save" onclick="copyText('shoppingListBody')">ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼</button>
            <button class="btn-line" onclick="sendToLine()">LINEã§é€ã‚‹</button>
        </div>
        <button class="btn-image" onclick="saveAsImage('shoppingListCard', 'è²·ã„ç‰©ãƒªã‚¹ãƒˆ')">ç”»åƒä¿å­˜</button>
    </div>

    <div id="dishPickerOverlay" onclick="closeDishPicker()">
        <div id="dishPickerContent" onclick="event.stopPropagation()">
            <div class="picker-title" id="pickerTitle">æ–™ç†ã®å¤‰æ›´</div>
            <div id="pickerFixArea"></div>
            <div class="picker-grid" id="pickerGrid"></div>
            <button class="btn-delete" style="margin-top:20px;" onclick="closeDishPicker()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        const STORAGE_KEY_DATA = 'Kondate_V50_Data';
        const STORAGE_KEY_PROFILES = 'Kondate_V50_Profiles';
        const SAMPLE_KEY = "ã‚µãƒ³ãƒ—ãƒ«(å®šç•ª)";
        const GITHUB_CSV_URL = "https://raw.githubusercontent.com/kodomocube/kondate/main/sample.csv";
        const DAYS = ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ", "æ—¥"];

        let isOrderOn = true;
        let checkedItems = new Set();

        const CATEGORY_ORDER = { "é‡èœãƒ»æœç‰©": 0, "è‚‰": 1, "é­š": 2, "ä¹³è£½å“ãƒ»è±†è…ãƒ»ç´è±†": 3, "å†·å‡ãƒ»åŠ å·¥é£Ÿå“": 4, "èª¿å‘³æ–™ãƒ»ãã®ä»–": 5 };
        const KEYWORDS = {
            "é‡èœãƒ»æœç‰©": ["ã‚­ãƒ£ãƒ™ãƒ„", "ãƒ¬ã‚¿ã‚¹", "ãƒˆãƒãƒˆ", "ç‰ã­ã", "äººå‚", "ãƒ”ãƒ¼ãƒãƒ³", "èŒ„å­", "ãã‚…ã†ã‚Š", "ã˜ã‚ƒãŒã„ã‚‚", "ç™½èœ", "ã­ã", "ãã®ã“", "ã»ã†ã‚Œã‚“è‰", "å°æ¾èœ", "ãƒ–ãƒ­ãƒƒã‚³ãƒªãƒ¼", "å¤§æ ¹", "ã‚Šã‚“ã”", "ãƒãƒŠãƒŠ"],
            "è‚‰": ["è±šè‚‰", "é¶è‚‰", "ç‰›è‚‰", "æŒ½è‚‰", "ã‚‚ã‚‚è‚‰", "ã‚€ã­è‚‰", "ãƒãƒ©", "ãƒ­ãƒ¼ã‚¹", "ãƒãƒ ", "ã‚½ãƒ¼ã‚»ãƒ¼ã‚¸", "ãƒ™ãƒ¼ã‚³ãƒ³"],
            "é­š": ["é­š", "é®­", "é¯–", "é±ˆ", "åˆºèº«", "æµ·è€", "è²", "ã‚¤ã‚«", "ã‚¿ã‚³", "ãƒ„ãƒŠ"],
            "ä¹³è£½å“ãƒ»è±†è…ãƒ»ç´è±†": ["åµ", "ç‰›ä¹³", "ãƒãƒ¼ã‚º", "ãƒã‚¿ãƒ¼", "è±†è…", "ç´è±†", "åšæšã’", "æ²¹æšã’", "ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ"],
            "å†·å‡ãƒ»åŠ å·¥é£Ÿå“": ["å†·å‡", "ã†ã©ã‚“", "ãƒ‘ã‚¹ã‚¿", "ãƒ‘ãƒ³", "é¤ƒå­"],
            "èª¿å‘³æ–™ãƒ»ãã®ä»–": ["é†¤æ²¹", "å‘³å™Œ", "ç ‚ç³–", "å¡©", "æ²¹", "é…¢", "ã‚±ãƒãƒ£ãƒƒãƒ—", "ãƒãƒ¨ãƒãƒ¼ã‚º", "ã ã—", "ã¤ã‚†", "ã‚«ãƒ¬ãƒ¼"]
        };

        function getCategory(ing) {
            for (const [cat, keys] of Object.entries(KEYWORDS)) { if (keys.some(k => ing.includes(k))) return cat; }
            return "èª¿å‘³æ–™ãƒ»ãã®ä»–";
        }

        function toggleOrder() {
            isOrderOn = !isOrderOn;
            const btn = document.getElementById('orderToggle');
            btn.innerText = `é™³åˆ—é †: ${isOrderOn ? 'ON' : 'OFF'}`;
            btn.className = `order-toggle-btn ${isOrderOn ? 'order-on' : 'order-off'}`;
            document.getElementById('orderDef').style.display = isOrderOn ? 'block' : 'none';
            updateShoppingList();
        }

        function resetShoppingCheck() {
            if (confirm("è³¼å…¥æ¸ˆã¿(æ‰“ã¡æ¶ˆã—ç·š)ã®ãƒã‚§ãƒƒã‚¯ã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                checkedItems.clear();
                updateShoppingList();
            }
        }

        function toggleItemCheck(ing) {
            if (checkedItems.has(ing)) checkedItems.delete(ing);
            else checkedItems.add(ing);
            updateShoppingList();
        }

        let profiles = JSON.parse(localStorage.getItem(STORAGE_KEY_PROFILES)) || {};
        let data = JSON.parse(localStorage.getItem(STORAGE_KEY_DATA)) || { mains:[], sides:[], salads:[], soups:[], currentPlan: Array.from({length: 7}, () => ({ main: "", side: "", salad: "", soup: "", mainFixed: false, sideFixed: false, saladFixed: false, soupFixed: false })) };

        async function init() {
            await syncSampleFromGitHubCSV();
            updateProfileSelect();
            renderAll();
            renderTable();
            updateBatchBtnLabels();
        }

        async function syncSampleFromGitHubCSV() {
            try {
                const response = await fetch(GITHUB_CSV_URL);
                if (!response.ok) throw new Error("GitHub fetch failed");
                const csvText = await response.text();
                const lines = csvText.split(/\r?\n/).filter(line => line.trim() !== "");
                const mains = [], sides = [], salads = [], soups = [];
                for (let i = 1; i < lines.length; i++) {
                    const [type, name, ingString] = lines[i].split(',');
                    if (!type || !name) continue;
                    const dish = { name: name.trim(), ing: ingString ? ingString.split('/').map(s => s.trim()) : [] };
                    const t = type.trim().toLowerCase();
                    if (t === 'main') mains.push(dish);
                    else if (t === 'side') sides.push(dish);
                    else if (t === 'salad') salads.push(dish);
                    else if (t === 'soup') soups.push(dish);
                }
                const githubProfile = { mains, sides, salads, soups, currentPlan: Array.from({length: 7}, () => ({ main: "", side: "", salad: "", soup: "", mainFixed: false, sideFixed: false, saladFixed: false, soupFixed: false })) };
                profiles[SAMPLE_KEY] = githubProfile;
                localStorage.setItem(STORAGE_KEY_PROFILES, JSON.stringify(profiles));
                if (data.mains.length === 0) { data = JSON.parse(JSON.stringify(githubProfile)); saveToLocal(); }
            } catch (e) { console.warn("GitHub CSV sync failed.", e); }
        }

        function toggleCompact() {
            const card = document.getElementById('planCard');
            const isNowCompact = card.classList.toggle('compact-mode');
            const btn = document.querySelector('.toggle-compact-btn');
            btn.innerText = isNowCompact ? "è©³ç´°è¡¨ç¤ºã«ã™ã‚‹" : "ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºã«ã™ã‚‹";
            renderTable();
        }

        function toggleBatchClear(type) {
            const allLocked = data.currentPlan.every(p => p[type + 'Fixed']);
            if (allLocked) {
                const inv = Array.from(document.getElementById('inventorySelect').selectedOptions).map(o => o.value);
                const exc = Array.from(document.getElementById('excludeSelect').selectedOptions).map(o => o.value);
                const want = Array.from(document.getElementById('wantToEatSelect').selectedOptions).map(o => o.value);
                const prio = document.getElementById('priorityMode').checked;
                let used = [];
                data.currentPlan.forEach(p => {
                    p[type + 'Fixed'] = false;
                    let pool = data[type + 's'].filter(d => !exc.includes(d.name) && !used.includes(d.name));
                    if (pool.length === 0) pool = data[type + 's'].filter(d => !exc.includes(d.name));
                    const d = pickDish(pool, want, inv, prio);
                    p[type] = d.name;
                    if(d.name) used.push(d.name);
                });
            } else {
                data.currentPlan.forEach(p => { p[type] = ""; p[type + 'Fixed'] = true; });
            }
            updateBatchBtnLabels();
            renderTable();
            saveToLocal();
        }

        function updateBatchBtnLabels() {
            const sBtn = document.getElementById('batchSaladBtn');
            const pBtn = document.getElementById('batchSoupBtn');
            const sLocked = data.currentPlan.every(p => p.saladFixed);
            const pLocked = data.currentPlan.every(p => p.soupFixed);
            sBtn.innerText = sLocked ? "ä¸€æ‹¬ã§ã‚µãƒ©ãƒ€ã‚’ã‚ã‚Šã«ã™ã‚‹" : "ä¸€æ‹¬ã§ã‚µãƒ©ãƒ€ã‚’ãªã—ã«ã™ã‚‹";
            pBtn.innerText = pLocked ? "ä¸€æ‹¬ã§ã‚¹ãƒ¼ãƒ—ã‚’ã‚ã‚Šã«ã™ã‚‹" : "ä¸€æ‹¬ã§ã‚¹ãƒ¼ãƒ—ã‚’ãªã—ã«ã™ã‚‹";
        }

        function renderAll() {
            ['main', 'side', 'salad', 'soup'].forEach(t => renderFullList(t));
            updateSelectors();
            saveToLocal();
        }

        function renderFullList(type) {
            const list = data[type + 's'];
            const container = document.getElementById(type + 'ListDisplay');
            container.innerHTML = list.map((d, i) => `<div class="list-item"><div class="edit-area"><span class="dish-name-edit" contenteditable="true" onblur="updateDishData('${type}',${i},'name',this)">${d.name}</span><span class="dish-ing-edit" contenteditable="true" onblur="updateDishData('${type}',${i},'ing',this)">${d.ing.join('ã€')}</span></div><span style="color:red; cursor:pointer;" onclick="deleteDish('${type}',${i})">âœ•</span></div>`).join('');
        }

        function updateDishData(t, i, f, el) {
            const val = el.innerText.trim();
            if (f === 'name') data[t + 's'][i].name = val;
            else data[t + 's'][i].ing = val.split(/[ã€,]+/).map(s => s.trim());
            renderAll(); renderTable();
        }

        function addDish(t) {
            const n = document.getElementById('addName').value.trim();
            const g = document.getElementById('addIng').value.split(/[ã€,]+/).map(s => s.trim()).filter(s => s);
            if (n) { data[t + 's'].push({ name: n, ing: g }); renderAll(); renderTable(); }
            document.getElementById('addName').value = ''; document.getElementById('addIng').value = '';
        }

        function deleteDish(t, i) { data[t + 's'].splice(i, 1); renderAll(); renderTable(); }

        function updateSelectors() {
            const allIng = [...new Set(['mains', 'sides', 'salads', 'soups'].flatMap(k => data[k].flatMap(d => d.ing)))].sort();
            const allNames = ['mains', 'sides', 'salads', 'soups'].flatMap(k => data[k].map(d => d.name)).sort();
            document.getElementById('inventorySelect').innerHTML = allIng.map(i => `<option value="${i}">${i}</option>`).join('');
            document.getElementById('excludeSelect').innerHTML = allNames.map(n => `<option value="${n}">${n}</option>`).join('');
            document.getElementById('wantToEatSelect').innerHTML = allNames.map(n => `<option value="${n}">${n}</option>`).join('');
        }

        function renderTable() {
            let html = "";
            DAYS.forEach((day, i) => {
                const p = data.currentPlan[i];
                html += `<tr class="day-row day-row-${i}">
                    <th class="day-header">${day}</th>
                    <td class="menu-content">
                        <div class="drop-row">
                            ${renderBadge(i, 'main', '#f06292', 'ä¸»èœ')}
                            ${renderBadge(i, 'side', '#ffb74d', 'å‰¯èœ')}
                        </div>
                        <div class="drop-row">
                            ${renderBadge(i, 'salad', '#aed581', 'ã‚µãƒ©ãƒ€')}
                            ${renderBadge(i, 'soup', '#9575cd', 'ã‚¹ãƒ¼ãƒ—')}
                        </div>
                        ${renderRow(i, 'main', 'ä¸»', 'label-main')}
                        ${renderRow(i, 'side', 'å‰¯', 'label-side')}
                        ${renderRow(i, 'salad', 'ã‚µ', 'label-salad')}
                        ${renderRow(i, 'soup', 'æ±', 'label-soup')}
                    </td>
                </tr>`;
            });
            document.getElementById('planBody').innerHTML = html;
            updateShoppingList();
        }

        function renderBadge(dayIdx, type, color, label) {
            const p = data.currentPlan[dayIdx];
            const name = p[type];
            const isFixed = p[type + 'Fixed'];
            const dish = data[type + 's'].find(d => d.name === name);
            const ingsText = dish ? dish.ing.join(',') : "";

            if (!name) return `<span class="drop-badge" style="background-color:#eee; color:#999;" onclick="openDishPicker(${dayIdx},'${type}')">${isFixed?'ğŸ”’':''}${label}ãªã—</span>`;
            
            return `<span class="drop-badge" style="background-color:${color}" onclick="openDishPicker(${dayIdx},'${type}')">
                <div class="dish-name">${isFixed?'ğŸ”’':''}${name}</div>
                <div class="dish-ings">${ingsText}</div>
            </span>`;
        }

        function renderRow(dayIdx, type, label, labelClass) {
            const p = data.currentPlan[dayIdx];
            const currentName = p[type];
            const isFixed = p[type + 'Fixed'];
            const dish = data[type + 's'].find(d => d.name === currentName) || {name:"", ing:[]};
            return `<div class="dish-section">
                <div class="dish-header-row">
                    <span class="dish-type-label ${labelClass}">${label}</span>
                    <span class="fix-btn ${isFixed?'fixed':''}" onclick="toggleFix(${dayIdx},'${type}')">${isFixed?'å›ºå®šON':'å›ºå®šOFF'}</span>
                    <select class="menu-select" onchange="updateChoice(${dayIdx},'${type}',this.value)">
                        <option value="">ãªã—</option>
                        ${data[type + 's'].map(d => `<option value="${d.name}" ${d.name===currentName?'selected':''}>${d.name}</option>`).join('')}
                    </select>
                </div>
                ${currentName ? `<div style="display:flex; gap:6px; margin-top:4px; flex-wrap:wrap;" class="recipe-links">
                    <a href="https://recipe.rakuten.co.jp/search/${encodeURIComponent(currentName)}/" target="_blank" class="search-link">æ¥½å¤©ãƒ¬ã‚·ãƒ”</a>
                    <a href="https://cookpad.com/search/${encodeURIComponent(currentName)}" target="_blank" class="search-link">ã‚¯ãƒƒã‚¯ãƒ‘ãƒƒãƒ‰</a>
                </div>` : ''}
                <small class="ing-text" style="display:block; margin-top:4px; font-size:0.65rem; color:#9e9e9e;">${dish.ing.join('ã€')}</small>
            </div>`;
        }

        function toggleFix(i, type) { data.currentPlan[i][type + 'Fixed'] = !data.currentPlan[i][type + 'Fixed']; updateBatchBtnLabels(); renderTable(); saveToLocal(); }
        function updateChoice(i, type, val) { data.currentPlan[i][type] = val; renderTable(); saveToLocal(); }

        function openDishPicker(dayIdx, type) {
            const overlay = document.getElementById('dishPickerOverlay');
            const grid = document.getElementById('pickerGrid');
            const title = document.getElementById('pickerTitle');
            const fixArea = document.getElementById('pickerFixArea');
            const typeJP = type === 'main' ? 'ä¸»èœ' : type === 'side' ? 'å‰¯èœ' : type === 'salad' ? 'ã‚µãƒ©ãƒ€' : 'ã‚¹ãƒ¼ãƒ—';
            const isFixed = data.currentPlan[dayIdx][type + 'Fixed'];
            title.innerText = `${DAYS[dayIdx]}æ›œæ—¥ã®${typeJP}ã‚’é¸æŠ`;
            fixArea.innerHTML = `<div class="fix-toggle-panel" onclick="toggleFix(${dayIdx},'${type}'); openDishPicker(${dayIdx},'${type}')"><span class="fix-status-label">${isFixed ? 'ğŸ”’ å›ºå®šä¸­' : 'ğŸ”“ æœªå›ºå®š'}</span><span class="fix-btn ${isFixed?'fixed':''}" style="margin:0">${isFixed?'è§£é™¤':'å›ºå®š'}</span></div>`;
            grid.innerHTML = `<div class="picker-btn none" onclick="updateChoice(${dayIdx},'${type}',''); closeDishPicker();">ãªã—</div>`;
            data[type + 's'].forEach(dish => { grid.innerHTML += `<div class="picker-btn" onclick="updateChoice(${dayIdx},'${type}','${dish.name}'); closeDishPicker();">${dish.name}</div>`; });
            overlay.style.display = 'flex';
        }
        function closeDishPicker() { document.getElementById('dishPickerOverlay').style.display = 'none'; }

        function generatePlan() {
            const inv = Array.from(document.getElementById('inventorySelect').selectedOptions).map(o => o.value);
            const exc = Array.from(document.getElementById('excludeSelect').selectedOptions).map(o => o.value);
            const want = Array.from(document.getElementById('wantToEatSelect').selectedOptions).map(o => o.value);
            const prio = document.getElementById('priorityMode').checked;
            const sideBatchDays = parseInt(document.getElementById('sideBatchDays').value);
            let usedM = data.currentPlan.filter(p => p.mainFixed).map(p => p.main);
            DAYS.forEach((_, i) => { if(!data.currentPlan[i].mainFixed) { let pool = data.mains.filter(d => !exc.includes(d.name) && !usedM.includes(d.name)); if(pool.length === 0) pool = data.mains.filter(d => !exc.includes(d.name)); const d = pickDish(pool, want, inv, prio); data.currentPlan[i].main = d.name; if(d.name) usedM.push(d.name); } });
            let currentSide = "", remainingBatch = 0, usedS = data.currentPlan.filter(p => p.sideFixed).map(p => p.side);
            DAYS.forEach((_, i) => { if (data.currentPlan[i].sideFixed) { remainingBatch = 0; return; } if (remainingBatch <= 0) { let pool = data.sides.filter(d => !exc.includes(d.name) && !usedS.includes(d.name)); if (pool.length === 0) pool = data.sides.filter(d => !exc.includes(d.name)); const d = pickDish(pool, want, inv, prio); currentSide = d.name; remainingBatch = sideBatchDays; if(d.name) usedS.push(d.name); } data.currentPlan[i].side = currentSide; remainingBatch--; });
            ['salad', 'soup'].forEach(type => { let used = data.currentPlan.filter(p => p[type+'Fixed']).map(p => p[type]); DAYS.forEach((_, i) => { if(!data.currentPlan[i][type+'Fixed']) { let pool = data[type+'s'].filter(d => !exc.includes(d.name) && !used.includes(d.name)); if(pool.length === 0) pool = data[type+'s'].filter(d => !exc.includes(d.name)); const d = pickDish(pool, want, inv, prio); data.currentPlan[i][type] = d.name; if(d.name) used.push(d.name); } }); });
            renderTable(); saveToLocal();
        }

        function pickDish(pool, want, inv, prio) { if (!pool || pool.length === 0) return {name:"", ing:[]}; let shuffled = shuffle([...pool]); let f = shuffled.filter(d => want.includes(d.name)); if (!f.length && prio) f = shuffled.filter(d => d.ing.some(i => inv.includes(i))); return (f.length ? f : shuffled)[0]; }
        function shuffle(a) { for(let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

        function updateShoppingList() {
            const inv = Array.from(document.getElementById('inventorySelect').selectedOptions).map(o => o.value);
            let ings = new Set();
            data.currentPlan.forEach(p => { ['main', 'side', 'salad', 'soup'].forEach(t => { const d = data[t+'s'].find(x => x.name === p[t]); if(d) d.ing.forEach(ing => ings.add(ing)); }); });
            let listArr = Array.from(ings);
            if (isOrderOn) {
                listArr.sort((a, b) => { const catA = getCategory(a), catB = getCategory(b); if (CATEGORY_ORDER[catA] !== CATEGORY_ORDER[catB]) return CATEGORY_ORDER[catA] - CATEGORY_ORDER[catB]; return a.localeCompare(b, 'ja'); });
            } else { listArr.sort((a, b) => a.localeCompare(b, 'ja')); }
            let currentCat = "", html = "";
            listArr.forEach(ing => {
                const cat = getCategory(ing), isChecked = checkedItems.has(ing);
                if (isOrderOn && cat !== currentCat) { html += `<li style="background:#fefefe; font-size:0.7rem; color:#888; padding:4px 12px; border-radius:0; box-shadow:none; border-bottom:1px solid #eee; cursor:default;" onclick="event.stopPropagation()">ã€${cat}ã€‘</li>`; currentCat = cat; }
                html += `<li class="${isChecked?'checked':''}" onclick="toggleItemCheck('${ing}')"><span>${ing}</span><div>${inv.includes(ing)?'<span class="batch-tag" style="background:#e1f5fe; color:#0288d1; padding:2px 6px; border-radius:10px; font-size:9px;">åœ¨åº«ã‚ã‚Š</span>':''}<a href="https://sm.rakuten.co.jp/search?keyword=${encodeURIComponent(ing)}" target="_blank" class="search-link" style="margin-left:8px; font-size: 0.55rem;" onclick="event.stopPropagation()">æ¥½å¤©ãƒãƒ¼ãƒˆã§è¦‹ã‚‹</a></div></li>`;
            });
            document.getElementById('shoppingListBody').innerHTML = html;
        }

        function updateProfileSelect() {
            const select = document.getElementById('profileSelect');
            let options = `<option value="${SAMPLE_KEY}">${SAMPLE_KEY}</option>`;
            Object.keys(profiles).forEach(name => { if (name !== SAMPLE_KEY) options += `<option value="${name}">${name}</option>`; });
            select.innerHTML = options;
        }

        function saveProfile() { const n = document.getElementById('profileName').value.trim(); if (n && n !== SAMPLE_KEY) { profiles[n] = JSON.parse(JSON.stringify(data)); localStorage.setItem(STORAGE_KEY_PROFILES, JSON.stringify(profiles)); updateProfileSelect(); alert("ä¿å­˜ã—ã¾ã—ãŸ"); } }
        function loadProfile() { const n = document.getElementById('profileSelect').value; data = JSON.parse(JSON.stringify(profiles[n] || { mains:[], sides:[], salads:[], soups:[], currentPlan: Array.from({length: 7}, () => ({ main: "", side: "", salad: "", soup: "", mainFixed: false, sideFixed: false, saladFixed: false, soupFixed: false })) })); renderAll(); renderTable(); updateBatchBtnLabels(); }
        function deleteProfile() { const n = document.getElementById('profileSelect').value; if (n === SAMPLE_KEY) return alert("ã‚µãƒ³ãƒ—ãƒ«ã¯å‰Šé™¤ä¸å¯"); if (confirm(n + " å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { delete profiles[n]; localStorage.setItem(STORAGE_KEY_PROFILES, JSON.stringify(profiles)); updateProfileSelect(); } }
        function exportCSV() { let csv = "Type,Name,Ingredients\n"; ['main', 'side', 'salad', 'soup'].forEach(t => data[t+'s'].forEach(d => csv += `${t},"${d.name}","${d.ing.join('/')}"\n`)); const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "my_dishes.csv"; link.click(); }
        function importCSV(input) { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { const lines = e.target.result.split(/\r?\n/); const newData = { mains:[], sides:[], salads:[], soups:[] }; for (let i = 1; i < lines.length; i++) { const row = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); if (row.length < 3) continue; const t = row[0].trim().toLowerCase() + 's'; const name = row[1].replace(/"/g, '').trim(); const ing = row[2].replace(/"/g, '').split('/').map(s => s.trim()).filter(s => s); if (newData[t]) newData[t].push({ name, ing }); } if (confirm(`èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ`)) { Object.assign(data, newData); renderAll(); renderTable(); } input.value = ""; }; reader.readAsText(file); }
        function clearUnfixed() { data.currentPlan.forEach(p => { ['main', 'side', 'salad', 'soup'].forEach(t => { if(!p[t+'Fixed']) p[t] = ""; }); }); renderTable(); saveToLocal(); }

        async function saveAsImage(id, name) {
            const card = document.getElementById(id);
            const links = card.querySelectorAll('.search-link'), btns = card.querySelectorAll('button');
            links.forEach(l => l.style.display = 'none'); btns.forEach(b => b.style.display = 'none');
            const canvas = await html2canvas(card, { scale: 2, backgroundColor: "#fff5f8", useCORS: true });
            links.forEach(l => l.style.display = 'inline-block'); btns.forEach(b => b.style.display = 'block');
            const link = document.createElement('a'); link.href = canvas.toDataURL("image/png"); link.download = `${name}.png`; link.click();
        }

        async function shareAsImage(id, name) {
            const card = document.getElementById(id);
            const links = card.querySelectorAll('.search-link'), btns = card.querySelectorAll('button');
            links.forEach(l => l.style.display = 'none'); btns.forEach(b => b.style.display = 'none');
            try {
                const canvas = await html2canvas(card, { scale: 2, backgroundColor: "#fff5f8", useCORS: true });
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const file = new File([blob], `${name}.png`, { type: 'image/png' });
                if (navigator.share && navigator.canShare({ files: [file] })) { await navigator.share({ files: [file], title: name }); }
            } catch (err) { console.error(err); } finally { links.forEach(l => l.style.display = 'inline-block'); btns.forEach(b => b.style.display = 'block'); }
        }

        function getShoppingText() {
            const lis = document.getElementById('shoppingListBody').querySelectorAll('li');
            return Array.from(lis).filter(li => !li.classList.contains('checked') && !li.innerText.startsWith('ã€')).map(li => li.innerText.replace('æ¥½å¤©ãƒãƒ¼ãƒˆã§è¦‹ã‚‹', '').trim()).join('\n');
        }

        function copyText(id) {
            let txt = "";
            if (id === 'planBody') txt = data.currentPlan.map((p,i) => `${DAYS[i]}: ${p.main||'-'} / ${p.side||'-'} / ${p.salad||'-'} / ${p.soup||'-'}`).join('\n');
            else if (id === 'shoppingListBody') txt = getShoppingText();
            navigator.clipboard.writeText(txt).then(() => alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"));
        }

        function sendToLine() { const txt = "ã€è²·ã„ç‰©ãƒªã‚¹ãƒˆã€‘\n" + getShoppingText(); window.open("https://line.me/R/msg/text/?" + encodeURIComponent(txt), '_blank'); }
        function saveToLocal() { localStorage.setItem(STORAGE_KEY_DATA, JSON.stringify(data)); }
        init();
    </script>
</body>
</html>
